"""add_system_session_type

Revision ID: 3c7cb17b16df
Revises: 10c58e701d87
Create Date: 2023-04-24 11:37:24.888451

"""

import textwrap

from alembic import op
from sqlalchemy.sql import text

from ai.backend.common.types import SessionTypes

# revision identifiers, used by Alembic.
revision = "3c7cb17b16df"
down_revision = "10c58e701d87"
branch_labels = None
depends_on = None

session_type_name = SessionTypes.__name__.lower()


def _add_enum_value(connection, enum_name: str, new_value: str) -> None:
    connection.execute(text(f"ALTER TYPE {enum_name} ADD VALUE '{new_value}';"))


def _delete_enum_value(connection, enum_name: str, value: str) -> None:
    connection.execute(text(textwrap.dedent(f"""DELETE FROM pg_enum
                    WHERE enumlabel = '{value}'
                    AND enumtypid = (
                    SELECT oid FROM pg_type WHERE typname = '{enum_name}'
                );""")))


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    conn = op.get_bind()
    _add_enum_value(conn, session_type_name, SessionTypes.SYSTEM)
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    conn = op.get_bind()
    _delete_enum_value(conn, session_type_name, SessionTypes.SYSTEM)
    # ### end Alembic commands ###
