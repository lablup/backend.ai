# Backend.AI Component Architecture

## Overview

Backend.AI is a modular cloud-native platform for managing AI/ML computing resources. It consists of multiple interconnected components, each responsible for specific areas of resource management, workload execution, and user interaction.

## System Architecture

### Component Overview

Backend.AI consists of the following core components:

- **Client**: REST/GraphQL requests via SDK, CLI, and Web UI
- **Webserver**: Web UI hosting and API Gateway role, session management
- **Hive Router**: GraphQL Federation Gateway (GraphQL routing between Webserver ↔ Manager)
- **Manager**: API business logic processing and session/deployment scheduling orchestration
- **App Proxy**: Service request routing and load balancing to sessions (Kernels)
- **Storage Proxy**: Virtual folder management and storage backend abstraction
- **Agent**: Kernel lifecycle management and resource monitoring on nodes
- **Kernel**: Container where actual user work is performed (Backend.AI's abstraction unit)

### Port Number Guide

All port numbers specified in this document are **based on the development environment** (`docker-compose.halfstack.current.yml`) and are generated by the `./scripts/install-dev.sh` script. Port numbers may vary in production environments depending on configuration.

#### Backend.AI Component Ports
- **Webserver**: 8090 (HTTP)
- **Manager**: 8091 (HTTP API)
- **Hive Router**: 4000 (GraphQL Gateway)
- **Agent RPC**: 6011 (ZeroMQ)
- **Storage Proxy**: 6021 (Client API), 6022 (Manager API)
- **App Proxy Coordinator**: 10200 (HTTP)
- **App Proxy Worker**: 10205-10300 (Traffic Proxy)

#### Internal Ports

Internal ports are used for internal service requests such as Prometheus metrics collection and service discovery. Currently, only Prometheus integration is implemented.

- **Manager**: 18080 (Prometheus metrics and service discovery)
- **Agent**: 6003 (Prometheus metrics, HTTP service API)
- **Storage Proxy**: 16023 (Prometheus metrics)

**Note**: The internal port is separate from the main API port to isolate internal monitoring traffic from user-facing API traffic.

#### Infrastructure Ports
- **PostgreSQL**: 8101 (host) → 5432 (container)
- **Redis**: 8111 (host) → 6379 (container)
- **etcd**: 8121 (host) → 2379 (container)
- **Prometheus**: 9090
- **Grafana**: 3000

### Flow-Based Architecture

#### 1. Backend.AI API Request Flow

Flow when users call Backend.AI APIs such as session creation and resource queries.

```
Client (SDK/CLI/Web UI)
  │
  ├─ REST request ──────→ Webserver ──→ Manager
  │                        (8090)         (8091)
  │
  └─ GraphQL request ───→ Webserver ──→ Hive Router ──→ Manager
                          (8090)         (4000)          (8091)
                                            │
                                            └─ HTTP SSE → WebSocket conversion
                                               (Subscription handling)

Manager
  │
  ├─→ Agent (ZeroMQ RPC): Kernel creation/management
  │
  ├─→ Storage Proxy (HTTP): VFolder management
  │
  └─→ App Proxy Coordinator (HTTP): Circuit registration
```

#### 2. Container Service Access Flow (e.g., Jupyter, VSCode)

Flow when users access services like Jupyter, VSCode in created sessions.

```
User Browser
  │
  └─→ App Proxy Worker (10205-10300) ──→ Kernel (Container)
                                           - Jupyter: 8888
                                           - VSCode: 8180
                                           - Other services

* Worker queries routing information from PostgreSQL/Redis/etcd
* Worker forwards traffic directly to Kernel on Agent node
```

#### 3. File Upload/Download Flow

Flow when uploading or downloading files to VFolder.

```
Client
  │
  └─→ Storage Proxy (6021) ──→ Backend Storage
       - Direct connection          - XFS
       (Bypassing Manager)          - CephFS
                                    - NetApp ONTAP
                                    - PureStorage
```

### Overall System Infrastructure Interaction

Shows connections between all Backend.AI components and infrastructure services. (See [Port Number Guide](#port-number-guide) for port numbers)

```
┌────────────────────────────────────────────────────────┐
│              Backend.AI User Layer                     │
├────────────────────────────────────────────────────────┤
│      Browser     │    Python SDK    │        CLI       │
└─────────────┬────┴──────────────┬───┴──────────────────┘
              │                   │
              │ HTTP/HTTPS        │ HTTP/GraphQL
              │                   │
              └───────────┬───────┘
                          ↓
                   ┌──────────────┐
                   │  Webserver   │
                   │   (8090)     │
                   │              │
                   │ - Web UI     │
                   │ - Gateway    │
                   │ - Sessions   │
                   └──────┬───────┘
                          │
                          │ (REST/GraphQL request proxy)
                          │
              ┌───────────┴───────────┐
              │                       │
         REST │                       │ GraphQL
              ↓                       ↓
       ┌─────────────┐         ┌─────────────┐
       │             │         │ Hive Router │
       │   Manager   │◄────────│   (4000)    │
       │   (8091)    │         │             │
       │             │         │ - GraphQL   │
       │ - API       │         │   Federation│
       │   Business  │         └─────────────┘
       │   Logic     │
       │ - Scheduling│
       │   Orchestr. │
       └──────┬──────┘
              │
              │ (Requests to Agent, Storage Proxy, App Proxy)
              │
       ┌──────┴─────────────────┬──────────────────────┐
       │                        │                      │
       │ ZeroMQ RPC             │ HTTP                 │ HTTP
       │ (6011)                 │ (6022)               │ (10200)
       ↓                        ↓                      ↓
      ┌───────────┐       ┌──────────────┐   ┌─────────────────────┐
      │   Agent   │       │Storage Proxy │   │App Proxy Coordinator│
      │  (6011)   │       │   (6022)     │   │      (10200)        │
      │           │       │              │   │                     │
      │ - Kernel  │       │ - VFolder    │   │ - Circuit mgmt      │
      │   create/ │       │   management │   │ - Health Check      │
      │   manage  │       │              │   │                     │
      └─────┬─────┘       └──────┬───────┘   └─────────┬───────────┘
            │                    │                     │
            │                    │                     │
            ↓                    ↓                     ↓
      ┌───────────┐       ┌───────────────┐   ┌────────────────────┐
      │  Kernel   │       │Backend Storage│   │   PostgreSQL       │
      │(Container)│       │               │   │   (Circuit info)   │
      │           │       │ - XFS         │   │                    │
      │ - Jupyter │       │ - CephFS      │   │ - Circuits         │
      │ - VSCode  │       │ - NetApp      │   │ - Workers          │
      │ - Other   │       └───────────────┘   └────────────────────┘
      └───────────┘
```

### Service User Access Flow

End-user flow accessing container services (Jupyter, VSCode, etc.).

```
┌─────────────────────────────────────────────┐
│      Service User Browser                   │
│  (Accessing Jupyter, VSCode, etc.)          │
└─────────────────┬───────────────────────────┘
                  │
                  │ HTTP/WebSocket
                  ↓
       ┌──────────────────────┐
       │   App Proxy Worker   │
       │      (10205-10300)   │
       │                      │
       │ - Service routing    │
       │ - Load balancing     │
       └──────────┬───────────┘
                  │
                  │ (Query routing info from etcd,
                  │  connect directly to Kernel,
                  │  not through Agent)
                  │
                  └─────────▶ Kernel (Container)
                              (Running on Agent node)
                              - Jupyter: 8888
                              - VSCode: 8180
                              - Other services
```

### Infrastructure Layer

(See [Port Number Guide](#port-number-guide) for port numbers)

```
┌─────────────────────────────────────────────────────────────┐
│                   Infrastructure Layer                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────┐  ┌─────────────┐  ┌──────────────────┐    │
│  │ PostgreSQL   │  │   Redis     │  │      etcd        │    │
│  │   (8101)     │  │   (8111)    │  │     (8121)       │    │
│  │              │  │             │  │                  │    │
│  │ Manager:     │  │ Manager:    │  │ Global config    │    │
│  │ - Users      │  │ - Cache     │  │ store:           │    │
│  │ - Sessions   │  │ - Events    │  │ - Container      │    │
│  │ - Agents     │  │ - Dist lock │  │   registry auth  │    │
│  │ - VFolders   │  │             │  │ - Storage volumes│    │
│  │              │  │ Webserver:  │  │ - Scaling groups │    │
│  │ App Proxy    │  │ - Web sess  │  │                  │    │
│  │ Coordinator: │  │             │  │ App Proxy:       │    │
│  │ - Circuits   │  │ App Proxy:  │  │ - Worker         │    │
│  │ - Workers    │  │ - Circuit   │  │   discovery      │    │
│  │              │  │   state     │  │ - Traefik routing│    │
│  └──────────────┘  └─────────────┘  └──────────────────┘    │
│                                                             │
│  ┌──────────────────────────────────────────────────────┐   │
│  │           Observability Stack (Required)             │   │
│  ├──────────────────────────────────────────────────────┤   │
│  │                                                      │   │
│  │  ┌────────────┐ (Direct collection - Pull)           │   │
│  │  │ Prometheus │◄─── Manager (Service Discovery)      │   │
│  │  │   (9090)   │◄─── Agent /metrics                   │   │
│  │  │            │◄─── Storage /metrics                 │   │
│  │  │            │◄─── Webserver /metrics               │   │
│  │  │            │◄─── App Proxy /metrics               │   │
│  │  │            │◄─── PostgreSQL Exporter (9187)       │   │
│  │  │            │◄─── Redis Exporter (9121)            │   │
│  │  └────────────┘                                      │   │
│  │        ▲                                             │   │
│  │        │ (Manager queries metrics)                   │   │
│  │        └─── Manager                                  │   │
│  │                                                      │   │
│  │  ┌─────────────────┐ (OTEL Collector - Push)         │   │
│  │  │ OTEL Collector  │◄─── All components              │   │
│  │  │ (4317/4318)     │      (logs, traces)             │   │
│  │  └────┬──────┬─────┘                                 │   │
│  │       │      │                                       │   │
│  │       ↓      ↓                                       │   │
│  │  ┌────────┐ ┌────────┐                               │   │
│  │  │  Loki  │ │ Tempo  │                               │   │
│  │  │ (3100) │ │ (3200) │                               │   │
│  │  └────────┘ └────────┘                               │   │
│  │                                                      │   │
│  │  ┌────────────┐                                      │   │
│  │  │  Grafana   │◄─── Prometheus, Loki, Tempo          │   │
│  │  │   (3000)   │      integration (visualization)     │   │
│  │  └────────────┘                                      │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## Development Setup

### Python Version Compatibility

Backend.AI requires specific Python and Pantsbuild versions for each release:

| Backend.AI Version | Python Version | Pantsbuild Version |
|:------------------|:--------------|:-------------------|
| 25.06.x ~ (main)  | 3.13.x        | 2.27.x             |
| 24.03.x ~ 25.05.x | 3.12.x        | 2.21.x             |
| 23.03.x / 23.09.x | 3.11.x        | 2.19.x             |
| 22.03.x / 22.09.x | 3.10.x        | -                  |
| 21.03.x / 21.09.x | 3.8.x         | -                  |

**Current main branch**:
- Python: CPython 3.13.7
- Pantsbuild: 2.27.0
- Versions defined in `pants.toml`

### Build System

Backend.AI uses **Pantsbuild** (version 2) as its build system and dependency manager.

**Key Commands**:
```bash
# Export virtual environment for development
pants export --resolve=python-default

# Update dependencies after modifying requirements.txt
pants generate-lockfiles --resolve=python-default

# Run linting
pants lint ::

# Run type checking
pants check ::

# Run tests
pants test ::

# Build packages
./scripts/build-wheels.sh  # Python wheels
./scripts/build-scies.sh   # SCIE executables
```

**Lock Files**:
- `python.lock` - Main source tree dependencies (python-default)
- `tools/*.lock` - Tool-specific dependencies (mypy, ruff, black, pytest, etc.)

### Database Schema Management

Backend.AI uses Alembic for database migrations:

```bash
# Manager database
./py -m alembic upgrade head
./py -m alembic revision --autogenerate -m "Description"

# App Proxy database
./py -m alembic -c alembic-appproxy.ini upgrade head

# Account Manager database
./py -m alembic -c alembic-accountmgr.ini upgrade head

# Check for migration conflicts
python scripts/check-multiple-alembic-heads.py
./py -m scripts/alembic-rebase.py {base_head} {top_head}
```

### Development Environment

**Single-node Development Setup**:
```bash
./scripts/install-dev.sh  # Automated setup script
```

This script:
- Checks Docker availability
- Sets up PostgreSQL, Redis, etcd containers
- Configures development environment

**Manual Component Startup**:
```bash
./backend.ai mgr start-server       # Manager
./backend.ai ag start-server        # Agent
./backend.ai storage start-server   # Storage Proxy
./backend.ai web start-server       # Webserver
```

**Development Ports** (from halfstack configuration):
- Webserver: 8090
- Manager: 8091 (API), 18080 (metrics)
- Agent: 6011 (RPC), 6003 (metrics)
- Storage Proxy: 6021 (client), 6022 (manager), 16023 (metrics)
- PostgreSQL: 8101 → 5432
- Redis: 8111 → 6379
- etcd: 8121 → 2379

### Contribution Guidelines

For contributing to Backend.AI:
- [CONTRIBUTING.md](../.github/CONTRIBUTING.md) - Development workflow and code standards
- [CLAUDE.md](../CLAUDE.md) - Guidelines for AI-assisted development
- [MIGRATION.md](../MIGRATION.md) - Major version migration guide

## Core Components

### [Manager](./manager/)

**Purpose**: Central API gateway and orchestrator

Manager receives REST/GraphQL requests, performs business logic, and acts as a central coordinator triggering actual work in other components (Agent, Storage Proxy, App Proxy).

**Key Responsibilities**:
- Provide REST/GraphQL API for client requests
- Perform session scheduling per Scaling Group
- Session and Deployment orchestration
- User authentication and RBAC authorization
- Metrics collection and Service Discovery endpoint

**Key Modules**:
- `api/`: REST and GraphQL API endpoints
- `actions/`: Permission validation and monitoring layer
- `services/`: Business logic implementation
- `repositories/`: Data access layer
- `sokovan/`: Session scheduling engine

**Detailed Documentation**:

For in-depth understanding of Manager's architecture and implementation:

- **[Manager Overview](./manager/README.md)**: Component overview, key responsibilities, and architectural layers
- **[Sokovan Orchestration](./manager/sokovan/README.md)**: Session scheduling orchestrator with 3-tier architecture
  - [Scheduler](./manager/sokovan/scheduler/README.md): Core scheduling engine for session placement
  - [Scheduling Controller](./manager/sokovan/scheduling_controller/README.md): Validation and preparation logic
  - [Deployment Controller](./manager/sokovan/deployment/README.md): Deployment management
- **[Services Layer](./manager/services/README.md)**: Business logic patterns and design principles
- **[Repositories Layer](./manager/repositories/README.md)**: Data access patterns and query optimization
- **[Actions Layer](./manager/actions/README.md)**: Permission validation and monitoring

### [Agent](./agent/)

**Purpose**: Kernel lifecycle management on compute nodes

Agent receives RPC requests from Manager to create/manage Kernels (container abstraction) on nodes and controls actual containers through the Docker backend.

**Key Responsibilities**:
- Receive Manager RPC requests and manage Kernel lifecycle (create, start, stop, delete)
- Monitor Kernel resource usage (CPU, memory, GPU)
- Report Agent status and resource availability to Manager
- Manage local scratch storage

**Key Modules**:
- `server.py`: RPC endpoints (receive Manager requests)
- `agent.py`: Kernel management logic (Agent's service layer)
- `docker/`: Docker container backend
- `watcher/`: Resource monitoring
- `stats.py`: Statistics collection

### [Storage Proxy](./storage/)

**Purpose**: Unified storage backend abstraction

**Key Responsibilities**:
- Provide virtual folder (vfolder) management
- Abstract multiple storage backends (NFS, CephFS, NetApp, etc.)
- Handle file upload/download
- Manage storage quota and permissions
- Support various enterprise storage solutions

**Key Modules**:
- `api/`: Storage management API
- `vfs/`: Virtual filesystem abstraction
- `volumes/`: Volume management
- `storages/`: Backend-specific implementations

### [Webserver](./web/)

**Purpose**: API Gateway and web UI hosting

Webserver provides the web UI and acts as a Gateway proxying all REST/GraphQL requests to Manager (or Hive Router). It does not directly handle user authentication but manages web sessions.

**Key Responsibilities**:
- Serve web UI assets (static files)
- Web session and cookie management
- Proxy REST requests to Manager
- Proxy GraphQL requests to Hive Router
- Provide security headers and CSRF protection

**Key Modules**:
- `auth.py`: Session management logic
- `proxy.py`: Proxy requests to Manager/Hive Router
- `security.py`: Security middleware
- `templates/`: Web UI templates

### [App Proxy](./appproxy/)

**Purpose**: Service request routing to sessions (Kernels)

App Proxy routes user container service access requests (Jupyter, VSCode, etc.) to corresponding Kernels. Manager registers Circuits via HTTP requests to the Coordinator, and users access Kernels through Workers.

**Key Responsibilities**:
- Route HTTP/WebSocket traffic to session services
- Load balance across multiple session Replicas for model services
- Perform Circuit Health Checks
- Dynamically manage service port mappings

**Components**:
- `coordinator/`: Circuit management and Health Check (Manager makes HTTP requests)
- `worker/`: Traffic proxy (users connect and forward to Kernels)
- `common/`: Shared types and utilities

### [Client SDK](./client/)

**Purpose**: Python SDK and CLI for Backend.AI API

Provides Python client library and CLI tools for making REST/GraphQL API requests to Backend.AI servers.

**Key Responsibilities**:
- Provide Python client library for API requests
- Implement CLI commands for users and administrators
- Support synchronous and asynchronous API clients

**Key Modules**:
- `cli/`: Command-line interface
- `session.py`: Session management API
- `func/`: Functional API wrappers
- `request.py`: HTTP request handling


## Component Dependencies

Summary of components and infrastructure each component depends on.

### Manager

- **Infrastructure**: PostgreSQL (data storage), Redis (caching, events, background task management), etcd (global configuration), Prometheus (metrics queries)
- **Components**: Agent (Kernel management), Storage Proxy (VFolder management), App Proxy (Circuit management)

### Agent

Agent only receives commands from Manager and does not receive direct requests from users or other components.

- **Infrastructure**: Container Runtime (Docker), Redis (event delivery, heartbeat, background task management), etcd (global configuration)
- **Components**: Manager (receive RPC commands), Storage Proxy (VFolder mounting)

### Storage Proxy

- **Infrastructure**: Backend Storage (XFS, CephFS, NetApp, etc.), Redis (optional caching, background task management), etcd (global configuration)
- **Components**: Manager (metadata sync)

### Webserver

- **Infrastructure**: Redis (web session storage), etcd (global configuration)
- **Components**: Manager (API proxy), Hive Router (GraphQL proxy)

### App Proxy

- **Infrastructure**: PostgreSQL (Circuit information), Redis (Health Check state with Manager), etcd (Worker discovery, Traefik routing)
- **Components**: Manager (Circuit registration), Agent (traffic forwarding)

## Infrastructure

Backend.AI uses various infrastructure components, with each component having required or optional dependencies.

### Required Infrastructure (Core Infrastructure)

#### PostgreSQL
- **Purpose**: Persistent data storage (users, sessions, resources, audit logs)
- **Version**: 16.3 or higher
- **Required by**: Manager, App Proxy Coordinator
- **Halfstack Port**: 8101
- **Data Volume**: `./volumes/postgres-data`
- **Component Usage**:
  - Manager: Main database (all tables)
  - App Proxy Coordinator: Circuit/Worker information (separate schema)

#### Redis
- **Purpose**: Cache, session storage, distributed locks, message queue
- **Version**: 7.2 or higher
- **Required by**: Manager, Webserver
- **Optional by**: Storage Proxy (caching)
- **Halfstack Port**: 8111
- **Data Volume**: `./volumes/redis-data`
- **Component Usage**:
  - Manager: Agent state caching, session scheduling, distributed locks
  - Webserver: Web session storage (required)
  - Storage Proxy: VFolder metadata caching (optional)

#### etcd
- **Purpose**: Global configuration store (easy configuration sharing across all components)
- **Version**: 3.5 or higher
- **Required by**: Manager, App Proxy Coordinator
- **Halfstack Port**: 8121
- **Data Volume**: `./volumes/etcd-data`
- **Key Configuration**:
  - Container registry authentication
  - Storage volume configuration
  - Scaling group configuration
  - App Proxy Worker discovery and Traefik routing information

#### Prometheus
- **Purpose**: Metrics collection and storage, Manager metrics query API
- **Version**: 3.1 or higher
- **Halfstack Port**: 9090
- **Components**: Manager (performs metrics queries), Agent, Storage Proxy, Webserver, App Proxy
- **Key Features**:
  - Use Manager's Service Discovery endpoint (`{MANAGER_ADDRESS}/metrics/service_discovery`)
  - Directly collect from all components' `/metrics` endpoints (Pull mode, not via OTEL Collector)
  - Collect per-Kernel container metrics
  - Query collected metrics from Manager (for internal services)
  - PostgreSQL/Redis Exporter integration

#### Hive Router (GraphQL Gateway)
- **Purpose**: GraphQL Federation Gateway (GraphQL routing between Webserver and Manager)
- **Image**: `ghcr.io/graphql-hive/gateway:2.1.12`
- **Halfstack Port**: 4000
- **Configuration**: `configs/graphql/gateway.config.ts`
- **Supergraph**: `docs/manager/graphql-reference/supergraph.graphql`
- **Features**:
  - Convert GraphQL Subscription from HTTP SSE → WebSocket
  - REST requests also support HTTP SSE
  - Requires Node.js v20+

### Observability Infrastructure (Observability Stack)

Monitoring and visualization infrastructure strongly recommended for production environments.

#### Grafana
- **Purpose**: Metrics, logs, and trace visualization
- **Version**: 11.4 or higher
- **Halfstack Port**: 3000
- **Data Sources**: Prometheus, Loki, Tempo, Pyroscope
- **Dashboards**: `configs/grafana/dashboards/`
- **Default Auth**: backend / develove

#### Loki
- **Purpose**: Log aggregation and search
- **Version**: 3.5 or higher
- **Halfstack Port**: 3100
- **Components**: All Backend.AI components
- **Config File**: `configs/loki/loki-config.yaml`
- **Log Transmission**:
  - Direct HTTP API calls
  - Use Promtail or Fluent Bit

#### Tempo
- **Purpose**: Distributed tracing
- **Version**: 2.7 or higher
- **Halfstack Port**: 3200 (HTTP), 4317 (OTLP gRPC)
- **Components**: Manager, App Proxy
- **Config File**: `configs/tempo/tempo-config.yaml`
- **Trace Collection**: OpenTelemetry SDK integration

#### OpenTelemetry Collector
- **Purpose**: Log and trace collection and transmission (Prometheus collects metrics directly)
- **Version**: 0.126 or higher
- **Halfstack Port**: 4317 (gRPC), 4318 (HTTP)
- **Config File**: `configs/otel/otel-collector-config.yaml`
- **Features**:
  - Collect logs and traces (Push mode)
  - Send data to Loki and Tempo
  - Data transformation and filtering

#### Pyroscope
- **Purpose**: Continuous profiling
- **Version**: 1.9 or higher
- **Halfstack Port**: 4040
- **Components**: Manager, Agent (Python code)
- **Profiling Types**: CPU, memory, blocking

### Exporters

Halfstack includes exporters for infrastructure metrics collection.

#### PostgreSQL Exporter
- **Image**: `prometheuscommunity/postgres-exporter`
- **Port**: 9187
- **Collected Metrics**: Connection count, query performance, table/index sizes

#### Redis Exporter
- **Image**: `oliver006/redis_exporter`
- **Port**: 9121
- **Collected Metrics**: Memory usage, key count, command statistics

### Additional Services

#### MinIO (for Reservoir service)
- **Purpose**: S3-compatible object storage (used by Reservoir feature)
- **Version**: latest
- **Halfstack Port**: 9000 (API), 9001 (Console)
- **Default Auth**: minioadmin / minioadmin
- **Data Volume**: `half-minio`
- **Note**: Not required when using only VFS Storage. Optional for typical Backend.AI use cases

### Infrastructure Dependency Matrix

| Infrastructure | Manager | Agent | Storage | Webserver | App Proxy | Note |
|----------------|---------|-------|---------|-----------|-----------|------|
| PostgreSQL | **Required** | - | - | - | **Required** (Coordinator) | Main database |
| Redis | **Required** | **Required** | **Required** | **Required** | **Required** | State storage (App Proxy, Manager, future Agent) & events (all components) |
| etcd | **Required** | **Required** | **Required** | **Required** | **Required** | Global config store (easy configuration sharing across all components) |
| Prometheus | **Required** | **Required** | Recommended | Recommended | Recommended | Metrics collection and queries (required for Manager and Agent) |
| Grafana | Recommended | Recommended | Recommended | Recommended | Recommended | Visualization (component-independent) |
| Loki | Recommended | Recommended | Recommended | Recommended | Recommended | Log aggregation (component-independent) |
| Tempo | Recommended | Recommended | Recommended | Recommended | Recommended | Tracing (component-independent) |
| OTEL Collector | Recommended | Recommended | Recommended | Recommended | Recommended | Log and trace collection (required when using Loki/Tempo) |

### Starting Halfstack Infrastructure

**Note**: `docker-compose.halfstack-main.yml` is the base template. In practice, use `docker-compose.halfstack.current.yml` generated after running the `./scripts/install-dev.sh` script.

#### Minimum Configuration (Required infrastructure only)
```bash
docker compose -f docker-compose.halfstack.current.yml up -d \
  backendai-half-db \
  backendai-half-redis \
  backendai-half-etcd \
  backendai-half-prometheus \
  backendai-hive-router
```

#### Full Configuration (Including observability)

Setting up the development environment via the `./scripts/install-dev.sh` script is recommended.

```bash
# Setup via script (recommended)
./scripts/install-dev.sh

# Or start all infrastructure directly
docker compose -f docker-compose.halfstack.current.yml up -d
```

### Development Environment Setup

Setting up the development environment via the `./scripts/install-dev.sh` script is recommended. This script generates necessary configuration files and starts infrastructure.

#### 1. Initialize Development Environment
```bash
./scripts/install-dev.sh
```

#### 2. Database Migration
```bash
# Manager schema migration
./py -m alembic upgrade head

# App Proxy schema migration
./py -m alembic -c alembic-appproxy.ini upgrade head
```

#### 3. Start Components

Start each component using configuration files generated by the `install-dev.sh` script:

```bash
# Manager
./backend.ai mgr start-server

# Agent
./backend.ai ag start-server

# Storage Proxy
./backend.ai storage start-server

# Webserver
./backend.ai web start-server

# App Proxy Coordinator
./backend.ai app-proxy-coordinator start-server

# App Proxy Worker
./backend.ai app-proxy-worker start-server
```

### Production Environment Considerations

#### High Availability
- **PostgreSQL**: Primary-Replica replication
- **Redis**: Redis Sentinel (Note: Cluster mode not supported)
- **etcd**: 3+ node cluster
- **App Proxy Coordinator**: Active-Standby

#### Backup and Recovery
- **PostgreSQL**: pg_dump or WAL archiving
- **Redis**: RDB or AOF snapshots
- **etcd**: Periodic snapshots

#### Monitoring

Manager provides a Prometheus Service Discovery endpoint (`{MANAGER_ADDRESS}/metrics/service_discovery`) to automate metrics collection configuration for all components.

- **Prometheus**: Automatically collect all component metrics via Manager's Service Discovery
- **Alertmanager**: Prometheus alerts
- **Grafana Alerting**: Dashboard-based alerts
- **Uptime**: Service availability monitoring

## Communication Protocols and Ports

See [Port Number Guide](#port-number-guide) for detailed port information.

### Inter-Component Communication

| Source → Destination | Protocol | Port | Purpose |
|---------------------|----------|------|---------|
| Client → Webserver | HTTP/HTTPS | 8090 | Web UI and API access |
| Webserver → Hive Router | HTTP | 4000 | GraphQL request routing |
| Hive Router → Manager | HTTP | 8091 | GraphQL Federation |
| Webserver → Manager | HTTP | 8091 | REST API proxy |
| Manager → Agent | ZeroMQ RPC | 6011 | Session management commands (create, destroy, execute) |
| Agent → Manager | ZeroMQ Event Push | 5002 | Status reports (kernel_created, stats) |
| Manager → Storage Proxy | HTTP | 6022 | VFolder management tasks |
| Client → Storage Proxy | HTTP | 6021 | File upload/download (direct access) |
| Manager → App Proxy Coordinator | HTTP | 10200 | Circuit registration and management |
| Client → App Proxy Worker | HTTP/WebSocket | 10205-10300 | Container app access |
| App Proxy Worker → Agent | HTTP/WebSocket | 30000-31000 | Container port forwarding |
| Agent → Storage Proxy | HTTP | 6021/6022 | VFolder mount info queries |

### Infrastructure Communication

| Component → Infrastructure | Protocol | Port | Purpose |
|---------------------------|----------|------|-------|
| Manager, App Proxy → PostgreSQL | asyncpg | 8101 | Persistent data storage/query |
| Manager, Webserver → Redis | RESP | 8111 | Caching, sessions, distributed locks |
| Manager, App Proxy → etcd | gRPC | 8121 | Configuration management, service discovery |
| All components → Prometheus | HTTP | 9090 | Metrics collection (pull mode) |
| All components → OTEL Collector | gRPC/HTTP | 4317/4318 | Log and trace transmission (push mode) |
| OTEL Collector → Loki | HTTP | 3100 | Log storage |
| OTEL Collector → Tempo | HTTP | 3200 | Trace storage |
| Prometheus → PostgreSQL Exporter | HTTP | 9187 | DB metrics collection |
| Prometheus → Redis Exporter | HTTP | 9121 | Redis metrics collection |

## Port Allocation Summary

### Backend.AI Component Ports

| Component | Port | Protocol | Purpose |
|-----------|---------|---------|-------|
| **Manager** | 8091 | HTTP | API server (REST/GraphQL) |
| | 18080 | HTTP | Internal API (metrics, Service Discovery) |
| | 5002 | ZeroMQ | Agent event reception |
| **Agent** | 6011 | ZeroMQ | RPC server (Manager command reception) |
| | 6003 | HTTP | Metrics API |
| | 30000-31000 | TCP/HTTP | Container service port pool |
| **Storage Proxy** | 6021 | HTTP | Client API (direct client access) |
| | 6022 | HTTP/gRPC | Manager API (Manager access) |
| **Webserver** | 8090 | HTTP/HTTPS | Web UI and API proxy |
| **Hive Router** | 4000 | HTTP | GraphQL Gateway |
| **App Proxy Coordinator** | 10200 | HTTP | Circuit management API |
| **App Proxy Worker** | 10201 | HTTP | Worker management API |
| | 10205-10300 | HTTP/WebSocket | Traffic proxy port pool |

### Halfstack Infrastructure Ports

| Infrastructure | Port | Protocol | Purpose |
|----------------|------|---------|-------|
| **PostgreSQL** | 8101 | PostgreSQL | Main database |
| **Redis** | 8111 | RESP | Cache and session store |
| **etcd** | 8121 | gRPC | Configuration and discovery |
| **Prometheus** | 9090 | HTTP | Metrics collection and queries |
| **Hive Router** | 4000 | HTTP | GraphQL Federation Gateway |
| **Grafana** | 3000 | HTTP | Dashboards and visualization |
| **Loki** | 3100 | HTTP | Log aggregation |
| **Tempo** | 3200 | HTTP | Tracing backend |
| **OTEL Collector** | 4317 | gRPC | Telemetry reception (gRPC) |
| | 4318 | HTTP | Telemetry reception (HTTP) |
| **Pyroscope** | 4040 | HTTP | Profiling |
| **MinIO** | 9000 | HTTP | S3 API |
| | 9001 | HTTP | Admin console |
| **PostgreSQL Exporter** | 9187 | HTTP | PostgreSQL metrics |
| **Redis Exporter** | 9121 | HTTP | Redis metrics |

## Development

See individual READMEs for each component's development setup instructions:
- [Manager Development Guide](./manager/README.md)
- [Agent Development Guide](./agent/README.md)
- [Storage Proxy Development Guide](./storage/README.md)
- [Webserver Development Guide](./web/README.md)
- [App Proxy Development Guide](./appproxy/README.md)

## References

- [Architecture Documentation](../../../docs/)
- [API Documentation](https://docs.backend.ai/)
- [GitHub Repository](https://github.com/lablup/backend.ai)
