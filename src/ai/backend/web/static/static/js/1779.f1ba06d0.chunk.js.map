{"version":3,"file":"static/js/1779.f1ba06d0.chunk.js","mappings":"6YA8CA,MAAMA,GAAoBC,EAAAA,EAAAA,IAA2B,IAC/CC,GAAmBD,EAAAA,EAAAA,IAAsB,CAAC,GAC1CE,GAAyBC,EAAAA,EAAAA,KAAYC,IAClCJ,EAAAA,EAAAA,KACJK,GAAQA,EAAIJ,GAAkBG,KAC/B,CAACC,EAAKC,EAAKC,KACT,MAAMC,EAAOH,EAAIJ,GACjBK,EAAIL,GAAgBQ,EAAAA,EAAAA,IAAAA,EAAAA,EAAAA,GAAA,GACfD,GAAI,IACP,CAACJ,GAAYG,IACb,MAyRR,EA9QoCG,KAGlC,MAAM,EAAEC,IAAMC,EAAAA,EAAAA,OACR,MAAEC,GAAUC,EAAAA,EAAMC,WAClBC,GAAYC,EAAAA,EAAAA,OACZ,mBAAEC,EAAkB,kBAAEC,IAAsBC,EAAAA,EAAAA,OAC5C,mBAAEC,IAAuBC,EAAAA,EAAAA,4BACxBC,EAAgBC,IAAqBC,EAAAA,EAAAA,IAAQ1B,IAC7C2B,EAAcC,IAAmBF,EAAAA,EAAAA,IAAQxB,IACzC2B,IAAwBC,EAAAA,EAAAA,GAC7B,0BAEIC,EAAQ,IAAIC,EAAAA,EAAO,CAAEC,YAAaJ,GAAwB,IAE1DK,GAAuBC,EAAAA,EAAAA,QAA+B,CAAC,GACvDC,EAA0BC,IAAAA,UAC9B,CAAChC,EAAmBiC,KAClB,MAAMC,EAAmBL,EAAqBM,QAAQnC,IAAc,EACpE6B,EAAqBM,QAAQnC,GAAa,EAE1CuB,GAAiBnB,IAAU,IAADgC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EACxB,MAAMC,GAAoC,QAAfV,EAAAhC,EAAKJ,UAAU,IAAAoC,GAAgB,QAAhBC,EAAfD,EAAiBW,sBAAc,IAAAV,OAAhB,EAAfA,EAAiCW,SAAU,EAChEC,IACY,QAAfX,EAAAlC,EAAKJ,UAAU,IAAAsC,GAAgB,QAAhBC,EAAfD,EAAiBS,sBAAc,IAAAR,OAAhB,EAAfA,EAAiCS,SAAU,KAC5B,QAAfR,EAAApC,EAAKJ,UAAU,IAAAwC,GAAa,QAAbC,EAAfD,EAAiBU,mBAAW,IAAAT,OAAb,EAAfA,EAA8BO,SAAU,KACzB,QAAfN,EAAAtC,EAAKJ,UAAU,IAAA0C,GAAc,QAAdC,EAAfD,EAAiBS,oBAAY,IAAAR,OAAd,EAAfA,EAA+BK,SAAU,GAEtCI,GAAmC,QAAfR,EAAAxC,EAAKJ,UAAU,IAAA4C,OAAA,EAAfA,EAAiBQ,oBAAqB,EAC1DC,IACY,QAAfR,EAAAzC,EAAKJ,UAAU,IAAA6C,OAAA,EAAfA,EAAiBS,iBAAkB,GAAKpB,EAmC3C,OAjCApB,EAAmB,CACjByC,IAAK,UAAYvD,EACjBwD,eAAgB,CACdC,OAAQ,UACRC,QACEN,EAAoB,EACfC,EAAwBD,EAAqB,IAC9C,EACNO,SAAU,CACRC,QAAS,CACPC,aACEC,EAAAA,EAAAA,MAACC,EAAAA,GAAO,CAACC,UAAU,SAASC,MAAM,QAAOC,SAAA,EACvCJ,EAAAA,EAAAA,MAACK,EAAAA,EAAWC,KAAI,CAAAF,SAAA,CACb3D,EAAE,2BAA2B,MAAIuC,EAAmB,KAAG,IACvDG,EAAwB,SAE3BoB,EAAAA,EAAAA,KAACF,EAAAA,EAAWC,KAAI,CACdE,UAAQ,EACRC,KAAK,YACLC,MAAO,CACLC,SAAUhE,EAAMiE,WAChBC,SAAU,SACVT,SAEDjC,aASf5B,EAAAA,EAAAA,IAAAA,EAAAA,EAAAA,GAAA,GACKD,GAAI,IACP,CAACJ,IAASK,EAAAA,EAAAA,IAAAA,EAAAA,EAAAA,GAAA,GACLD,EAAKJ,IAAU,IAClBsD,eAAgBD,KACjB,GAEH,GAEJ,IACA,CAAEuB,SAAS,EAAMC,UAAU,IAgM7B,OA7LAC,EAAAA,EAAAA,YAAU,KACsB,IAA1B3D,EAAe6B,QAAiBpC,IAEpCO,EAAe4D,SAASC,IACtB,MAAM,UAAEhF,EAAS,YAAEiF,EAAW,eAAEC,GAAmBF,EAC7CG,EAAsBnD,IAAAA,MAC1BkD,GACCE,GAASA,EAAKC,KAAKC,OAGtB/D,GAAiBnB,IAAU,IAADmF,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EACxB,MAAMC,GAAiBzF,EAAKJ,GACtB8F,IACY,QAAfP,EAAAnF,EAAKJ,UAAU,IAAAuF,OAAA,EAAfA,EAAiBnC,oBAAqB,GAAK+B,EACxCY,EAAUF,EACZ,IACiB,QAAfL,EAAApF,EAAKJ,UAAU,IAAAwF,OAAA,EAAfA,EAAiBlC,iBAAkB,GAAKwC,EAC1C,IA6BJ,OA3BAhF,EAAmB,CACjByC,IAAK,UAAYvD,EACjBgG,MAAM,EACNC,SACEnC,EAAAA,EAAAA,MAAA,QAAAI,SAAA,CACG3D,EAAE,oBAAoB,SACvB8D,EAAAA,EAAAA,KAAC6B,EAAAA,GAAO,CACN1B,MAAO,CACL2B,WAAY,UAEdC,GAAInF,EAAmBjB,GACvBqG,QAASA,KACPtF,EAAkB,UAAYf,EAAU,EACxCkE,SAAA,GAAAoC,OACCrB,QAGTzB,eAAgB,CACdC,OAAQ,UACRC,QAASqC,EACTpC,SAAU,CACRC,QAASrD,EAAE,+BAGfgG,SAAU,KAGZlG,EAAAA,EAAAA,IAAAA,EAAAA,EAAAA,GAAA,GACKD,GAAI,IACP,CAACJ,GAAY,CACXiF,cACA9B,aAAc,KACO,QAAfsC,EAAArF,EAAKJ,UAAU,IAAAyF,OAAA,EAAfA,EAAiBtC,eAAgB,MAClC+B,EAAesB,KACfpB,GAASA,EAAKC,KAAKoB,oBAAsBrB,EAAKC,KAAKqB,QAGxD3D,gBAA+B,QAAf2C,EAAAtF,EAAKJ,UAAU,IAAA0F,OAAA,EAAfA,EAAiB3C,iBAAkB,GACnDG,aAA4B,QAAfyC,EAAAvF,EAAKJ,UAAU,IAAA2F,OAAA,EAAfA,EAAiBzC,cAAe,GAC7CI,gBAA+B,QAAfsC,EAAAxF,EAAKJ,UAAU,IAAA4F,OAAA,EAAfA,EAAiBtC,iBAAkB,EACnDF,kBAAmB0C,IACpB,IAILZ,EAAeH,SAAQ4B,IAA8B,IAA7B,KAAEtB,EAAI,cAAEuB,GAAeD,EAC7CjF,EAAMmF,KAAIC,UAER,MAAM7E,EAAWoD,EAAKoB,oBAAsBpB,EAAKqB,KACjD,IAAIK,EAAwB,EAE5B,UACQH,EAAc,CAClBI,WAAYA,CAACC,EAAeC,EAAajF,KAEvC,MAAMkF,EAAaF,EAAgBF,EACnCA,EAAwBE,EACxBpF,EAAqBM,QAAQnC,IAC1B6B,EAAqBM,QAAQnC,IAAc,GAAKmH,EAEnDpF,EAAwB/B,EAAWiC,EAAS,IAKhDF,EAAwBqF,eACjBvF,EAAqBM,QAAQnC,GAEpCuB,GAAiBnB,IAAI,IAAAiH,EAAA,OAAAhH,EAAAA,EAAAA,IAAAA,EAAAA,EAAAA,GAAA,GAChBD,GAAI,IACP,CAACJ,IAASK,EAAAA,EAAAA,IAAAA,EAAAA,EAAAA,GAAA,GACLD,EAAKJ,IAAU,IAClBmD,aAAc/C,EAAKJ,GAAWmD,aAAamE,QACxCC,GAAcA,IAAMtF,IAEvBc,eAAgB,KACK,QAAfsE,EAAAjH,EAAKJ,UAAU,IAAAqH,OAAA,EAAfA,EAAiBtE,iBAAkB,GACvCd,MAEH,GAEL,CAAE,MAAOuF,GAEPzF,EAAwBqF,eACjBvF,EAAqBM,QAAQnC,GAEpCuB,GAAiBnB,IAAI,IAAAqH,EAAA,OAAApH,EAAAA,EAAAA,IAAAA,EAAAA,EAAAA,GAAA,GAChBD,GAAI,IACP,CAACJ,IAASK,EAAAA,EAAAA,IAAAA,EAAAA,EAAAA,GAAA,GACLD,EAAKJ,IAAU,IAClBmD,aAAc/C,EAAKJ,GAAWmD,aAAamE,QACxCC,GAAcA,IAAMtF,IAEvBiB,YAAa,KACQ,QAAfuE,EAAArH,EAAKJ,UAAU,IAAAyH,OAAA,EAAfA,EAAiBvE,cAAe,GACpCjB,MAEH,GAEL,IACA,GACF,IAEJb,EAAkB,IAAG,GAEpB,CAACD,KAEJ2D,EAAAA,EAAAA,YAAU,KACR4C,OAAOC,QAAQrG,GAAcyD,SAAQ6C,IAA0B,IAAxB5H,EAAWyD,GAAOmE,EAClD5F,IAAAA,QAAgB,OAANyB,QAAM,IAANA,OAAM,EAANA,EAAQN,gBAElBnB,IAAAA,QAAgB,OAANyB,QAAM,IAANA,OAAM,EAANA,EAAQP,aAkBXlB,IAAAA,QAAgB,OAANyB,QAAM,IAANA,OAAM,EAANA,EAAQV,kBAC5BjC,EAAmB,CACjByC,IAAK,UAAYvD,EACjBgG,MAAM,EACNC,SACEnC,EAAAA,EAAAA,MAAA,QAAAI,SAAA,CACG3D,EAAE,oBAAoB,SACvB8D,EAAAA,EAAAA,KAAC6B,EAAAA,GAAO,CACN1B,MAAO,CACL2B,WAAY,UAEdC,GAAInF,EAAmBjB,GACvBqG,QAASA,KACPtF,EAAkB,UAAYf,EAAU,EACxCkE,SAAA,GAAAoC,OACO,OAAN7C,QAAM,IAANA,OAAM,EAANA,EAAQwB,kBAGjBzB,eAAgB,CACdC,OAAQ,WACRC,QAAS,IACTC,SAAU,CACRkE,SAAUtH,EAAE,2CAGhBgG,SAAU,IAEZhF,GAAiBnB,IAAIC,EAAAA,EAAAA,IAAAA,EAAAA,EAAAA,GAAA,GAChBD,GAAI,IACP,CAACJ,IAASK,EAAAA,EAAAA,IAAAA,EAAAA,EAAAA,GAAA,GACLD,EAAKJ,IAAU,IAClB+C,eAAgB,GAChBO,eAAgB,EAChBF,kBAAmB,SAlDvBtC,EAAmB,CACjByC,IAAK,UAAYvD,EACjBgG,MAAM,EACNC,QAAS1F,EAAE,wBAAyB,CAClCuH,WAAkB,OAANrE,QAAM,IAANA,OAAM,EAANA,EAAQwB,cAEtBzB,eAAgB,CACdC,OAAQ,WACRC,QAAS,EACTC,SAAU,CACRoE,SAAUxH,EAAE,4BAA6B,CACvCuH,WAAkB,OAANrE,QAAM,IAANA,OAAM,EAANA,EAAQwB,gBAI1B+C,iBAAkBhG,IAAAA,KAAa,OAANyB,QAAM,IAANA,OAAM,EAANA,EAAQP,YAAa,QAsClD,GACA,GAED,CAAC5B,IAEG,IAAI,EAKA2G,EAAuBA,CAAAC,EAAAJ,KAAA,MAAAK,GAAAC,EAAAA,EAAAA,GAAC,IAGnCxH,GAAkByH,EAAAA,EAAAA,OACb,EAAL9H,IAAcC,EAAAA,EAAAA,OACT,mBAALM,IAA+BE,EAAAA,EAAAA,MAE/BI,GAA0BkH,EAAAA,EAAAA,IAAW3I,GAAmB,IAAA4I,EAAAJ,EAAA,KAAAD,GAGtDK,EAAAL,GAAKM,EAAAA,EAAAA,IAAUN,GAAGO,QAAS,KAAM,IAAjC,GAAyCN,EAAA,GAAAD,EAAAC,EAAA,GAAAI,GAAAA,EAAAJ,EAAA,GAD3C,MAAA7G,EAAAC,IA9RAvB,EA+REuI,GA7RKlH,EAAAA,EAAAA,IAAQvB,EAAuBE,KAFtCA,MAgSE,IAAA0I,EAAAP,EAAA,KAAAvH,GAAAuH,EAAA,KAAAL,GAAAK,EAAA,KAAA5H,GAAA4H,EAAA,KAAArH,GAE4B4H,EAAAA,CAAAC,EAAAC,KAI5B,MAAAC,EAA4BjI,EAASkI,QAAQC,kBAC7CC,EAA2BhH,IAAAA,IACzB2G,EACAM,GACDC,OAAQC,EAAoC,GAE7C,QAAIN,EAAsB,GAAKG,EAAqBH,KAClD/H,EAAmB,CAAAkF,MACX,EAAIzC,IACL,UAAYqF,EAAS3C,QACjB1F,EAAE,wBAAyB,CAAAuH,WACN,OAAhBA,QAAgB,IAAhBA,EAAAA,EAAA,KACZjE,YACWtD,EAAE,qCAAoCgG,SACzC,EAAC6C,OACH7I,EAAE,4BAA2B6F,GACjC,CAAAiD,OACM,IAAIC,gBAAgB,CAAAC,OAClBX,IACRY,eAGC,EAEE,EACZrB,EAAA,GAAAvH,EAAAuH,EAAA,GAAAL,EAAAK,EAAA,GAAA5H,EAAA4H,EAAA,GAAArH,EAAAqH,EAAA,GAAAO,GAAAA,EAAAP,EAAA,GA7BD,MAAAsB,EAA8Bf,EA6B5B,IAAAgB,EAAAvB,EAAA,KAAAvH,GAAAuH,EAAA,KAAAL,GAAAK,EAAA,KAAA/G,GAAA+G,EAAA,MAAAsB,GAEkBC,EAAA5C,MAAA6C,EAAAC,EAAAC,KAKlB,IAAKJ,EAAsBE,EAAOf,GAAU,OAE5C,MAAAkB,EAAoC,GACpCC,EAA+B/H,IAAAA,IAAM2H,GAAOK,IAC1CF,EAAYG,KAAM5E,GACXyB,UAOL,MAAA7E,EAAiBoD,EAAIoB,oBAAuBpB,EAAIqB,KAEhD,IACE,MAAAwD,EAAmB,CAACL,EAAa5H,GAASqF,OAAQ6C,SAAQC,KAAM,KAEhEC,QACQzJ,EAAS0J,QAAQC,sBACrBL,EACA7E,EACAuD,GACA,aAES,IAAI4B,SACf,CAAAC,EAAAC,KACE,IACiB,IAAIC,EAAAA,GAAWtF,EAAM,CAAAuF,SACxBP,EAASA,YAAAQ,YAEN,CAAC,EAAG,IAAM,IAAM,IAAO,KAAMC,UAC/BC,EAAoB1F,EAAIC,MAAM0F,6BACZ,EAAKC,SACxB,CAAAC,SACE7F,EAAIqB,KAAKyE,SACT9F,EAAId,MACfyC,WACWA,CAAAC,EAAAmE,KAAA,IAAAC,EACD,OAATC,QAAS,IAATA,GAIC,QAJQD,EAATC,EAAStE,kBAIR,IAAAqE,GAJDA,EAAAE,KAAAD,EACErE,EACAmE,EACAnJ,EACD,EACFuJ,UACUA,KACTf,EAAQ,CAAA/D,KACAzE,EAAQwJ,MACPpG,EAAIC,MACX,EACHoG,QACQC,IAEPjB,EAAO,IAAIkB,MAAM,qBAADtF,OAAsBrE,IAAY,IAGhD4J,OAAS,CAAD,MAAAC,GAGdpB,EACE,IAAIkB,MAAM,mCAADtF,OAAoCrE,IAC7C,IAGN,CAAD,MAAA8J,GAID,MAAM,IAAIH,MAAM,gCAADtF,OAAiCrE,GAAY,MAKlE+J,EAAyC,CAAAhM,UAC5B4I,EAAS3D,YACS,OAAhB6C,QAAgB,IAAhBA,EAAAA,EAAA,GAAgB5C,eACblD,IAAAA,QACd8H,EACAC,EACAkC,IAMJ7K,GAAkBhB,GAAU,IAAIA,EAAM4L,IAAmB,EAC1D7D,EAAA,GAAAvH,EAAAuH,EAAA,GAAAL,EAAAK,EAAA,GAAA/G,EAAA+G,EAAA,IAAAsB,EAAAtB,EAAA,IAAAuB,GAAAA,EAAAvB,EAAA,IA1FD,MAAA+D,EAAoBxC,EA0FlB,IAAAqC,EAMD,OANC5D,EAAA,MAAA5G,GAAA4G,EAAA,MAAA+D,GAAA/D,EAAA,MAAA7G,GAEKyK,EAAA,CAAAzK,eAAAC,kBAAA2K,eAIN/D,EAAA,IAAA5G,EAAA4G,EAAA,IAAA+D,EAAA/D,EAAA,IAAA7G,EAAA6G,EAAA,IAAA4D,GAAAA,EAAA5D,EAAA,IAJM4D,CAIN,EAGGhB,EAAuBoB,IAC3B,MAAMC,EAAK,QAEX,OAAID,GAAY,KAAWC,EAClB,IAAMA,EACJD,GAAY,KAAWC,EACzB,IAAMA,EACJD,GAAY,IAAMC,EACpB,GAAKA,EAEL,GAAKA,CACd,EA1JkC,SAAAnD,EAAA5D,GAAA,OAoBpBA,EAAIC,IAAK,CApBW,SAAA6D,EAAAkD,EAAA/G,GAAA,OAqBRgH,KAAID,IAAKA,EAAK/G,EAAK,CArBX,SAAA2G,EAAAM,EAAA3F,GAAA,MA+HF,CAAAvB,KACxBA,EAAIuB,gBAEL,C","sources":["components/FileUploadManager.tsx"],"sourcesContent":["import { useSetBAINotification } from '../hooks/useBAINotification';\nimport { useFolderExplorerOpener } from './FolderExplorerOpener';\nimport { theme, Typography } from 'antd';\nimport { RcFile } from 'antd/es/upload';\nimport {\n  BAIFlex,\n  BAILink,\n  toLocalId,\n  useConnectedBAIClient,\n} from 'backend.ai-ui';\nimport { atom, useAtom, useSetAtom } from 'jotai';\nimport { atomFamily } from 'jotai/utils';\nimport _ from 'lodash';\nimport PQueue from 'p-queue';\nimport { useEffect, useRef } from 'react';\nimport { useTranslation } from 'react-i18next';\nimport { useSuspendedBackendaiClient } from 'src/hooks';\nimport { useBAISettingUserState } from 'src/hooks/useBAISetting';\nimport * as tus from 'tus-js-client';\n\ntype uploadStartFunction = (callbacks?: {\n  onProgress?: (\n    bytesUploaded: number,\n    bytesTotal: number,\n    fileName: string,\n  ) => void;\n}) => Promise<{ name: string; bytes: number }>;\n\ntype UploadRequest = {\n  vFolderId: string;\n  vFolderName: string;\n  uploadFileInfo: Array<{ file: RcFile; startFunction: uploadStartFunction }>;\n};\n\ntype UploadStatusInfo = {\n  vFolderName: string;\n  pendingFiles: Array<string>;\n  completedFiles: Array<string>;\n  failedFiles: Array<string>;\n  completedBytes: number;\n  totalExpectedSize: number;\n};\ntype UploadStatusMap = {\n  [vFolderId: string]: UploadStatusInfo;\n};\n\nconst uploadRequestAtom = atom<Array<UploadRequest>>([]);\nconst uploadStatusAtom = atom<UploadStatusMap>({});\nconst uploadStatusAtomFamily = atomFamily((vFolderId: string) => {\n  return atom(\n    (get) => get(uploadStatusAtom)[vFolderId],\n    (get, set, newStatus: UploadStatusInfo) => {\n      const prev = get(uploadStatusAtom);\n      set(uploadStatusAtom, {\n        ...prev,\n        [vFolderId]: newStatus,\n      });\n    },\n  );\n});\n\nconst useUploadStatusAtomStatus = (\n  vFolderId: string,\n): [UploadStatusInfo, (newStatus: UploadStatusInfo) => void] => {\n  return useAtom(uploadStatusAtomFamily(vFolderId));\n};\n\nconst FileUploadManager: React.FC = () => {\n  'use memo';\n\n  const { t } = useTranslation();\n  const { token } = theme.useToken();\n  const baiClient = useSuspendedBackendaiClient();\n  const { upsertNotification, closeNotification } = useSetBAINotification();\n  const { generateFolderPath } = useFolderExplorerOpener();\n  const [uploadRequests, setUploadRequests] = useAtom(uploadRequestAtom);\n  const [uploadStatus, setUploadStatus] = useAtom(uploadStatusAtom);\n  const [maxConcurrentUploads] = useBAISettingUserState(\n    'max_concurrent_uploads',\n  );\n  const queue = new PQueue({ concurrency: maxConcurrentUploads || 2 });\n\n  const pendingDeltaBytesRef = useRef<Record<string, number>>({});\n  const throttledUploadRequests = _.throttle(\n    (vFolderId: string, fileName: string) => {\n      const accumulatedDelta = pendingDeltaBytesRef.current[vFolderId] || 0;\n      pendingDeltaBytesRef.current[vFolderId] = 0;\n\n      setUploadStatus((prev) => {\n        const uploadedFilesCount = prev[vFolderId]?.completedFiles?.length || 0;\n        const totalUploadedFilesCount =\n          (prev[vFolderId]?.completedFiles?.length || 0) +\n          (prev[vFolderId]?.failedFiles?.length || 0) +\n          (prev[vFolderId]?.pendingFiles?.length || 0);\n\n        const totalExpectedSize = prev[vFolderId]?.totalExpectedSize || 0;\n        const currentCompletedBytes =\n          (prev[vFolderId]?.completedBytes || 0) + accumulatedDelta;\n\n        upsertNotification({\n          key: 'upload:' + vFolderId,\n          backgroundTask: {\n            status: 'pending',\n            percent:\n              totalExpectedSize > 0\n                ? (currentCompletedBytes / totalExpectedSize) * 100\n                : 0,\n            onChange: {\n              pending: {\n                description: (\n                  <BAIFlex direction=\"column\" align=\"start\">\n                    <Typography.Text>\n                      {t('explorer.UploadingFiles')} ( {uploadedFilesCount} /{' '}\n                      {totalUploadedFilesCount} )\n                    </Typography.Text>\n                    <Typography.Text\n                      ellipsis\n                      type=\"secondary\"\n                      style={{\n                        fontSize: token.fontSizeSM,\n                        maxWidth: '300px',\n                      }}\n                    >\n                      {fileName}\n                    </Typography.Text>\n                  </BAIFlex>\n                ),\n              },\n            },\n          },\n        });\n\n        return {\n          ...prev,\n          [vFolderId]: {\n            ...prev[vFolderId],\n            completedBytes: currentCompletedBytes,\n          },\n        };\n      });\n    },\n    200,\n    { leading: true, trailing: true },\n  );\n\n  useEffect(() => {\n    if (uploadRequests.length === 0 || !baiClient) return;\n\n    uploadRequests.forEach((uploadRequest) => {\n      const { vFolderId, vFolderName, uploadFileInfo } = uploadRequest;\n      const currUploadTotalSize = _.sumBy(\n        uploadFileInfo,\n        (info) => info.file.size,\n      );\n\n      setUploadStatus((prev) => {\n        const isFirstUpload = !prev[vFolderId];\n        const newTotalExpectedSize =\n          (prev[vFolderId]?.totalExpectedSize || 0) + currUploadTotalSize;\n        const currPct = isFirstUpload\n          ? 0\n          : ((prev[vFolderId]?.completedBytes || 0) / newTotalExpectedSize) *\n            100;\n\n        upsertNotification({\n          key: 'upload:' + vFolderId,\n          open: true,\n          message: (\n            <span>\n              {t('explorer.VFolder')}:&nbsp;\n              <BAILink\n                style={{\n                  fontWeight: 'normal',\n                }}\n                to={generateFolderPath(vFolderId)}\n                onClick={() => {\n                  closeNotification('upload:' + vFolderId);\n                }}\n              >{`${vFolderName}`}</BAILink>\n            </span>\n          ),\n          backgroundTask: {\n            status: 'pending',\n            percent: currPct,\n            onChange: {\n              pending: t('explorer.ProcessingUpload'),\n            },\n          },\n          duration: 0,\n        });\n\n        return {\n          ...prev,\n          [vFolderId]: {\n            vFolderName,\n            pendingFiles: [\n              ...(prev[vFolderId]?.pendingFiles || []),\n              ...uploadFileInfo.map(\n                (info) => info.file.webkitRelativePath || info.file.name,\n              ),\n            ],\n            completedFiles: prev[vFolderId]?.completedFiles || [],\n            failedFiles: prev[vFolderId]?.failedFiles || [],\n            completedBytes: prev[vFolderId]?.completedBytes || 0,\n            totalExpectedSize: newTotalExpectedSize,\n          },\n        };\n      });\n\n      uploadFileInfo.forEach(({ file, startFunction }) => {\n        queue.add(async () => {\n          // Capture fileName before any async operations\n          const fileName = file.webkitRelativePath || file.name;\n          let previousBytesUploaded = 0;\n\n          try {\n            await startFunction({\n              onProgress: (bytesUploaded, _bytesTotal, fileName) => {\n                // Since bytesUploaded is cumulative, calculate delta from previous value\n                const deltaBytes = bytesUploaded - previousBytesUploaded;\n                previousBytesUploaded = bytesUploaded;\n                pendingDeltaBytesRef.current[vFolderId] =\n                  (pendingDeltaBytesRef.current[vFolderId] || 0) + deltaBytes;\n\n                throttledUploadRequests(vFolderId, fileName);\n              },\n            });\n\n            // Success case\n            throttledUploadRequests.flush();\n            delete pendingDeltaBytesRef.current[vFolderId];\n\n            setUploadStatus((prev) => ({\n              ...prev,\n              [vFolderId]: {\n                ...prev[vFolderId],\n                pendingFiles: prev[vFolderId].pendingFiles.filter(\n                  (f: string) => f !== fileName,\n                ),\n                completedFiles: [\n                  ...(prev[vFolderId]?.completedFiles || []),\n                  fileName,\n                ],\n              },\n            }));\n          } catch (error) {\n            // Error case - use the captured fileName regardless of error structure\n            throttledUploadRequests.flush();\n            delete pendingDeltaBytesRef.current[vFolderId];\n\n            setUploadStatus((prev) => ({\n              ...prev,\n              [vFolderId]: {\n                ...prev[vFolderId],\n                pendingFiles: prev[vFolderId].pendingFiles.filter(\n                  (f: string) => f !== fileName,\n                ),\n                failedFiles: [\n                  ...(prev[vFolderId]?.failedFiles || []),\n                  fileName,\n                ],\n              },\n            }));\n          }\n        });\n      });\n    });\n    setUploadRequests([]);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [uploadRequests]);\n\n  useEffect(() => {\n    Object.entries(uploadStatus).forEach(([vFolderId, status]) => {\n      if (!_.isEmpty(status?.pendingFiles)) return;\n\n      if (!_.isEmpty(status?.failedFiles)) {\n        upsertNotification({\n          key: 'upload:' + vFolderId,\n          open: true,\n          message: t('explorer.UploadFailed', {\n            folderName: status?.vFolderName,\n          }),\n          backgroundTask: {\n            status: 'rejected',\n            percent: 0,\n            onChange: {\n              rejected: t('explorer.FileUploadFailed', {\n                folderName: status?.vFolderName,\n              }),\n            },\n          },\n          extraDescription: _.join(status?.failedFiles, ', '),\n        });\n      } else if (!_.isEmpty(status?.completedFiles)) {\n        upsertNotification({\n          key: 'upload:' + vFolderId,\n          open: true,\n          message: (\n            <span>\n              {t('explorer.VFolder')}:&nbsp;\n              <BAILink\n                style={{\n                  fontWeight: 'normal',\n                }}\n                to={generateFolderPath(vFolderId)}\n                onClick={() => {\n                  closeNotification('upload:' + vFolderId);\n                }}\n              >{`${status?.vFolderName}`}</BAILink>\n            </span>\n          ),\n          backgroundTask: {\n            status: 'resolved',\n            percent: 100,\n            onChange: {\n              resolved: t('explorer.SuccessfullyUploadedToFolder'),\n            },\n          },\n          duration: 3,\n        });\n        setUploadStatus((prev) => ({\n          ...prev,\n          [vFolderId]: {\n            ...prev[vFolderId],\n            completedFiles: [],\n            completedBytes: 0,\n            totalExpectedSize: 0,\n          },\n        }));\n      }\n    });\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [uploadStatus]);\n\n  return null;\n};\n\nexport default FileUploadManager;\n\nexport const useFileUploadManager = (id?: string, folderName?: string) => {\n  'use memo';\n\n  const baiClient = useConnectedBAIClient();\n  const { t } = useTranslation();\n  const { upsertNotification } = useSetBAINotification();\n\n  const setUploadRequests = useSetAtom(uploadRequestAtom);\n\n  const [uploadStatus, setUploadStatus] = useUploadStatusAtomStatus(\n    id ? toLocalId(id).replace(/-/g, '') : '', // since jotai atom doesn't use '-' in key, we need to replace it\n  );\n\n  const validateUploadRequest = (\n    requestedFiles: Array<RcFile>,\n    vfolderId: string,\n  ) => {\n    const maxPossibleFileSize = baiClient._config.maxFileUploadSize;\n    const maxRequestFileSize = _.map(\n      requestedFiles,\n      (file) => file.size,\n    ).reduce((max, size) => Math.max(max, size), 0);\n\n    if (maxPossibleFileSize > 0 && maxRequestFileSize > maxPossibleFileSize) {\n      upsertNotification({\n        open: true,\n        key: 'upload:' + vfolderId,\n        message: t('explorer.UploadFailed', {\n          folderName: folderName ?? '',\n        }),\n        description: t('data.explorer.FileUploadSizeLimit'),\n        duration: 3,\n        toText: t('data.folders.OpenAFolder'),\n        to: {\n          search: new URLSearchParams({\n            folder: vfolderId,\n          }).toString(),\n        },\n      });\n      return false;\n    }\n    return true;\n  };\n\n  const uploadFiles = async (\n    files: RcFile[],\n    vfolderId: string,\n    currentPath: string,\n  ) => {\n    if (!validateUploadRequest(files, vfolderId)) return;\n\n    const fileToUpload: Array<RcFile> = [];\n    const startUploadFunctionMap = _.map(files, (file) => {\n      fileToUpload.push(file);\n      return async (callbacks?: {\n        onProgress?: (\n          bytesUploaded: number,\n          bytesTotal: number,\n          fileName: string,\n        ) => void;\n      }) => {\n        const fileName = file.webkitRelativePath || file.name;\n\n        try {\n          const uploadPath = [currentPath, fileName].filter(Boolean).join('/');\n\n          const uploadUrl: string =\n            await baiClient.vfolder.create_upload_session(\n              uploadPath,\n              file,\n              vfolderId,\n            );\n\n          return await new Promise<{ name: string; bytes: number }>(\n            (resolve, reject) => {\n              try {\n                const upload = new tus.Upload(file, {\n                  endpoint: uploadUrl,\n                  uploadUrl: uploadUrl,\n                  retryDelays: [0, 3000, 5000, 10000, 20000],\n                  chunkSize: getOptimalChunkSize(file.size),\n                  storeFingerprintForResuming: false, // Disable localStorage storage\n                  metadata: {\n                    filename: file.name,\n                    filetype: file.type,\n                  },\n                  onProgress: (bytesUploaded, bytesTotal) => {\n                    callbacks?.onProgress?.(\n                      bytesUploaded,\n                      bytesTotal,\n                      fileName,\n                    );\n                  },\n                  onSuccess: () => {\n                    resolve({\n                      name: fileName,\n                      bytes: file.size,\n                    });\n                  },\n                  onError: (_error) => {\n                    // Always reject with consistent structure\n                    reject(new Error(`Upload failed for ${fileName}`));\n                  },\n                });\n                upload.start();\n              } catch (error) {\n                // Handle synchronous errors from tus.Upload constructor or start()\n                reject(\n                  new Error(`Failed to initialize upload for ${fileName}`),\n                );\n              }\n            },\n          );\n        } catch (error) {\n          // Handle API errors or any other errors\n          // Always throw with a consistent error message\n          throw new Error(`Failed to prepare upload for ${fileName}`);\n        }\n      };\n    });\n\n    const uploadRequestInfo: UploadRequest = {\n      vFolderId: vfolderId,\n      vFolderName: folderName ?? '',\n      uploadFileInfo: _.zipWith(\n        fileToUpload,\n        startUploadFunctionMap,\n        (file, startFunction) => ({\n          file,\n          startFunction,\n        }),\n      ),\n    };\n    setUploadRequests((prev) => [...prev, uploadRequestInfo]);\n  };\n\n  return {\n    uploadStatus,\n    setUploadStatus,\n    uploadFiles,\n  };\n};\n\nconst getOptimalChunkSize = (fileSize: number): number => {\n  const MB = 1024 * 1024;\n\n  if (fileSize >= 5 * 1024 * MB) {\n    return 200 * MB;\n  } else if (fileSize >= 1 * 1024 * MB) {\n    return 100 * MB;\n  } else if (fileSize >= 100 * MB) {\n    return 50 * MB;\n  } else {\n    return 15 * MB;\n  }\n};\n"],"names":["uploadRequestAtom","atom","uploadStatusAtom","uploadStatusAtomFamily","atomFamily","vFolderId","get","set","newStatus","prev","_objectSpread","FileUploadManager","t","useTranslation","token","theme","useToken","baiClient","useSuspendedBackendaiClient","upsertNotification","closeNotification","useSetBAINotification","generateFolderPath","useFolderExplorerOpener","uploadRequests","setUploadRequests","useAtom","uploadStatus","setUploadStatus","maxConcurrentUploads","useBAISettingUserState","queue","PQueue","concurrency","pendingDeltaBytesRef","useRef","throttledUploadRequests","_","fileName","accumulatedDelta","current","_prev$vFolderId","_prev$vFolderId$compl","_prev$vFolderId2","_prev$vFolderId2$comp","_prev$vFolderId3","_prev$vFolderId3$fail","_prev$vFolderId4","_prev$vFolderId4$pend","_prev$vFolderId5","_prev$vFolderId6","uploadedFilesCount","completedFiles","length","totalUploadedFilesCount","failedFiles","pendingFiles","totalExpectedSize","currentCompletedBytes","completedBytes","key","backgroundTask","status","percent","onChange","pending","description","_jsxs","BAIFlex","direction","align","children","Typography","Text","_jsx","ellipsis","type","style","fontSize","fontSizeSM","maxWidth","leading","trailing","useEffect","forEach","uploadRequest","vFolderName","uploadFileInfo","currUploadTotalSize","info","file","size","_prev$vFolderId7","_prev$vFolderId8","_prev$vFolderId9","_prev$vFolderId0","_prev$vFolderId1","_prev$vFolderId10","isFirstUpload","newTotalExpectedSize","currPct","open","message","BAILink","fontWeight","to","onClick","concat","duration","map","webkitRelativePath","name","_ref","startFunction","add","async","previousBytesUploaded","onProgress","bytesUploaded","_bytesTotal","deltaBytes","flush","_prev$vFolderId11","filter","f","error","_prev$vFolderId12","Object","entries","_ref2","resolved","folderName","rejected","extraDescription","useFileUploadManager","id","$","_c","useConnectedBAIClient","useSetAtom","t0","toLocalId","replace","t1","requestedFiles","vfolderId","maxPossibleFileSize","_config","maxFileUploadSize","maxRequestFileSize","_temp","reduce","_temp2","toText","search","URLSearchParams","folder","toString","validateUploadRequest","t2","files","vfolderId_0","currentPath","fileToUpload","startUploadFunctionMap","file_0","push","uploadPath","Boolean","join","uploadUrl","vfolder","create_upload_session","Promise","resolve","reject","tus","endpoint","retryDelays","chunkSize","getOptimalChunkSize","storeFingerprintForResuming","metadata","filename","filetype","bytesTotal","_callbacks$onProgress","callbacks","call","onSuccess","bytes","onError","_error","Error","start","t4","t3","uploadRequestInfo","_temp3","uploadFiles","fileSize","MB","max","Math","file_1"],"ignoreList":[],"sourceRoot":""}