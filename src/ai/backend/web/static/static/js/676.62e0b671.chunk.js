"use strict";(self.webpackChunkbackend_ai_webui_react=self.webpackChunkbackend_ai_webui_react||[]).push([[676],{85676:(e,n,i)=>{i.d(n,{A:()=>w});var l=i(30032),a=i(83468),t=i(90660),o=i(5621),r=i(29871);var s,d=i(35051),m=i(81638),u=i(65080),v=i(50840),c=i(30217),g=i(48713),p=i(64283),h=i(82028),f=i(45901),y=i.n(f),x=i(76998),A=i(77678),k=i(3606),_=i(23446);const w=e=>{let{filter:n,showPrivate:f}=e;const w=u.A.useFormInstance(),j=u.A.useWatch("environments",{form:w,preserve:!0}),b=(0,a.CX)(),[F,S]=(0,x.useState)(""),[N,I]=(0,x.useState)(""),{t:V}=(0,A.Bd)(),[K,{getImageMeta:E}]=(0,a.Gj)(),{token:C}=v.A.useToken(),{isDarkMode:M}=(0,t.e)(),z=(0,x.useRef)(null),G=(0,x.useRef)(null),{images:L}=(0,k.useLazyLoadQuery)(void 0!==s?s:s=i(5739),{installed:!0},{fetchPolicy:"store-and-network"});(0,x.useEffect)((()=>{var e,n,i;if(!y().isEmpty(null===j||void 0===j?void 0:j.manual))return void((j.environment||j.version)&&w.setFieldsValue({environments:{environment:void 0,version:void 0,image:void 0}}));let a,t,o,r,s=null===(e=w.getFieldValue("environments"))||void 0===e?void 0:e.version;var d,m;(s&&s.indexOf("@")<0&&(s+="@x86_64"),s&&y().find(B,(e=>(a=y().find(e.environmentGroups,(e=>(t=y().find(e.images,(e=>(0,l.A_)(e)===s)),!!t))),!!a))),a?(o=a,r=t):w.getFieldValue(["environments","environment"])&&y().find(B,(e=>{var n;return o=y().find(e.environmentGroups,(e=>e.environmentName===w.getFieldValue(["environments","environment"]))),r=null===(n=o)||void 0===n?void 0:n.images[0],!!o})),o&&r)||(o=null===(d=B[0])||void 0===d?void 0:d.environmentGroups[0],r=null===(m=o)||void 0===m?void 0:m.images[0]);const u=null===(n=y().find(null===(i=r)||void 0===i?void 0:i.labels,(e=>null!==e&&"ai.backend.customized-image.name"===(null===e||void 0===e?void 0:e.key))))||void 0===n?void 0:n.value;r?!a&&b._config.allow_manual_image_name_for_session&&s?w.setFieldsValue({environments:{environment:void 0,version:void 0,image:void 0,manual:s,customizedTag:null!==u&&void 0!==u?u:void 0}}):w.setFieldsValue({environments:{environment:o.environmentName,version:(0,l.A_)(r),image:r,customizedTag:null!==u&&void 0!==u?u:void 0}}):b._config.allow_manual_image_name_for_session&&w.setFieldValue(["environments","manual"],s)}),[null===j||void 0===j?void 0:j.version,null===j||void 0===j?void 0:j.manual]);const B=(0,x.useMemo)((()=>y().chain(L).filter((e=>(!!f||!(e=>y().some(null===e||void 0===e?void 0:e.labels,(e=>{var n;return"ai.backend.features"===(null===e||void 0===e?void 0:e.key)&&(null===e||void 0===e||null===(n=e.value)||void 0===n?void 0:n.split(" ").includes("private"))})))(e))&&(!n||n(e)))).groupBy((e=>{var n;return(null===K||void 0===K||null===(n=K.imageInfo[E((0,l.A_)(e)||"").key])||void 0===n?void 0:n.group)||"Custom Environments"})).map(((e,n)=>({groupName:n,environmentGroups:y().chain(e).groupBy((e=>(null===e||void 0===e?void 0:e.registry)+"/"+(null===e||void 0===e?void 0:e.name))).map(((e,n)=>{var i,l;const a=null===(i=n.split("/"))||void 0===i?void 0:i[2];return{environmentName:n,displayName:a&&(null===K||void 0===K||null===(l=K.imageInfo[a])||void 0===l?void 0:l.name)||y().last(n.split("/")),prefix:y().chain(n).split("/").drop(1).dropRight(1).join("/").value(),images:e.sort(((e,n)=>{var i,l,a,t,o,r;return function(e,n){const i=e.split(".").map(Number),l=n.split(".").map(Number);for(let a=0;a<Math.max(i.length,l.length);a++){const e=i[a]||0,n=l[a]||0;if(e>n)return 1;if(e<n)return-1}return 0}(null!==(i=null===n||void 0===n||null===(l=n.tag)||void 0===l||null===(a=l.split("-"))||void 0===a?void 0:a[0])&&void 0!==i?i:"",null!==(t=null===e||void 0===e||null===(o=e.tag)||void 0===o||null===(r=o.split("-"))||void 0===r?void 0:r[0])&&void 0!==t?t:"")}))}})).sortBy((e=>e.displayName)).value()}))).sortBy((e=>e.groupName)).value()),[L,K,n,f]),{fullNameMatchedImage:R}=(0,x.useMemo)((()=>{let e,n;return F.length&&y().chain(B.flatMap((e=>e.environmentGroups)).find((i=>(n=i,e=y().find(i.images,(e=>(0,l.A_)(e)===F)),!!e)))).value(),{fullNameMatchedImage:e,fullNameMatchedImageGroup:n}}),[F,B]);return(0,_.jsxs)(_.Fragment,{children:[(0,_.jsx)("style",{children:"/* Change the image and tags of the select option when the selection is opened  */\ndiv.image-environment-select-form-item\n  div.ant-select-open\n  span.ant-select-selection-item\n  div\n  img,\ndiv.image-environment-select-form-item\n  div.ant-select-open\n  span.ant-select-selection-item\n  div\n  span.ant-tag {\n  opacity: 0.5;\n}\n\ndiv.image-environment-select-form-item\n  div.ant-select-item-option-content\n  div.tag-wrap-light {\n  /* flex: 1 !important; */\n  flex-wrap: wrap !important;\n}\n\ndiv.image-environment-select-form-item\n  div.ant-select-item-option-content\n  div.tag-wrap-dark {\n  /* flex: 1 !important; */\n  flex-wrap: wrap !important;\n}\n\ndiv.image-environment-select-form-item\n  span.ant-select-selection-item\n  div.tag-wrap-light {\n  overflow: hidden;\n}\n\ndiv.image-environment-select-form-item\n  span.ant-select-selection-item\n  div.tag-wrap-dark {\n  overflow: hidden;\n}\n\ndiv.image-environment-select-form-item\n  span.ant-select-selection-item\n  div.tag-wrap-light::after {\n  content: '';\n  position: absolute;\n  top: 0;\n  right: 0;\n  bottom: 0;\n  width: 10px; /* Width of the transparent gradient area */\n  background: linear-gradient(\n    to right,\n    rgba(255, 255, 255, 0),\n    rgba(255, 255, 255, 1)\n  );\n}\n\ndiv.image-environment-select-form-item\n  span.ant-select-selection-item\n  div.tag-wrap-dark::after {\n  content: '';\n  position: absolute;\n  top: 0;\n  right: 0;\n  bottom: 0;\n  width: 10px;\n  background: linear-gradient(\n    to right,\n    rgba(20, 20, 20, 0),\n    rgba(20, 20, 20, 1)\n  );\n}\n"}),(0,_.jsx)(u.A.Item,{className:"image-environment-select-form-item",name:["environments","environment"],label:"".concat(V("session.launcher.Environments")," / ").concat(V("session.launcher.Version")),rules:[{required:y().isEmpty(null===j||void 0===j?void 0:j.manual)}],style:{marginBottom:10},children:(0,_.jsx)(c.A,{ref:z,showSearch:!0,className:"image-environment-select",searchValue:F,onSearch:S,defaultActiveFirstOption:!0,optionFilterProp:"filterValue",onChange:e=>{if(R)w.setFieldsValue({environments:{environment:(null===R||void 0===R?void 0:R.name)||"",version:(0,l.A_)(R),image:R}});else{const n=B.flatMap((e=>e.environmentGroups)).filter((n=>n.environmentName===e))[0].images[0];w.setFieldsValue({environments:{environment:(null===n||void 0===n?void 0:n.name)||"",version:(0,l.A_)(n),image:n}})}},disabled:b._config.allow_manual_image_name_for_session&&!y().isEmpty(null===j||void 0===j?void 0:j.manual),children:R?(0,_.jsx)(c.A.Option,{value:null===R||void 0===R?void 0:R.name,filterValue:(0,l.A_)(R),children:(0,_.jsxs)(r.A,{direction:"row",align:"center",gap:"xs",style:{display:"inline-flex"},children:[(0,_.jsx)(d.A,{image:(0,l.A_)(R)||"",style:{width:15,height:15}}),(0,l.A_)(R)]})}):y().map(B,(e=>(0,_.jsx)(c.A.OptGroup,{label:e.groupName,children:y().map(e.environmentGroups,(e=>{var n;const i=e.images[0],a=null===K||void 0===K?void 0:K.imageInfo[null===(n=e.environmentName.split("/"))||void 0===n?void 0:n[2]],t=[];let o=null;e.prefix&&!["lablup","cloud","stable"].includes(e.prefix)&&(t.push(e.prefix),o=(0,_.jsx)(g.A,{color:"purple",children:(0,_.jsx)(m.A,{keyword:F,children:e.prefix})}));const s=y().map(null===a||void 0===a?void 0:a.label,(e=>y().isUndefined(e.category)&&e.tag&&e.color?(t.push(e.tag),(0,_.jsx)(g.A,{color:e.color,children:(0,_.jsx)(m.A,{keyword:F,children:e.tag},e.tag)},e.tag)):null));return(0,_.jsx)(c.A.Option,{value:e.environmentName,filterValue:e.displayName+"\t"+t.join("\t"),children:(0,_.jsxs)(r.A,{direction:"row",justify:"between",children:[(0,_.jsxs)(r.A,{direction:"row",align:"center",gap:"xs",children:[(0,_.jsx)(d.A,{image:(0,l.A_)(i)||"",style:{width:15,height:15}}),(0,_.jsx)(m.A,{keyword:F,children:e.displayName})]}),(0,_.jsxs)(r.A,{direction:"row",className:M?"tag-wrap-dark":"tag-wrap-light",style:{marginLeft:C.marginXS,flexShrink:1},children:[o,s]})]})},e.environmentName)}))},e.groupName)))})}),(0,_.jsx)(u.A.Item,{noStyle:!0,shouldUpdate:(e,n)=>{var i,l;return(null===(i=e.environments)||void 0===i?void 0:i.environment)!==(null===(l=n.environments)||void 0===l?void 0:l.environment)},children:e=>{var n;let i,{getFieldValue:a}=e;return y().find(B,(e=>y().find(e.environmentGroups,(e=>{var n;return e.environmentName===(null===(n=a("environments"))||void 0===n?void 0:n.environment)&&(i=e,!0)})))),(0,_.jsx)(u.A.Item,{className:"image-environment-select-form-item",name:["environments","version"],rules:[{required:y().isEmpty(null===j||void 0===j?void 0:j.manual)}],children:(0,_.jsx)(c.A,{ref:G,onChange:e=>{const n=y().find(L,(n=>(0,l.A_)(n)===e));w.setFieldValue(["environments","image"],n)},showSearch:!0,searchValue:N,onSearch:I,optionFilterProp:"filterValue",dropdownRender:e=>(0,_.jsxs)(_.Fragment,{children:[(0,_.jsxs)(r.A,{style:{fontWeight:C.fontWeightStrong,paddingLeft:C.paddingSM},children:[V("session.launcher.Version"),(0,_.jsx)(p.A,{type:"vertical"}),V("session.launcher.Base"),(0,_.jsx)(p.A,{type:"vertical"}),V("session.launcher.Architecture"),(0,_.jsx)(p.A,{type:"vertical"}),V("session.launcher.Requirements")]}),(0,_.jsx)(p.A,{style:{margin:"8px 0"}}),e]}),disabled:b._config.allow_manual_image_name_for_session&&!y().isEmpty(null===j||void 0===j?void 0:j.manual),children:y().map(y().uniqBy(null===(n=i)||void 0===n?void 0:n.images,"digest"),(e=>{var n;const[i,a,...t]=(null===e||void 0===e||null===(n=e.tag)||void 0===n?void 0:n.split("-"))||["","",""];let s=null===K||void 0===K?void 0:K.tagAlias[a];if(!s){for(const[e,n]of Object.entries((null===K||void 0===K?void 0:K.tagReplace)||{})){const i=new RegExp(e);i.test(a)&&(s=null===a||void 0===a?void 0:a.replace(i,n))}s||(s=a)}const d=[],u=y().chain(t).filter((e=>!e.startsWith("customized_"))).map(((e,n)=>(0,_.jsx)(o.A,{values:y().split((null===K||void 0===K?void 0:K.tagAlias[e])||e,":").map((e=>(d.push(e),(0,_.jsx)(m.A,{keyword:N,children:e},e))))},n))).value(),v=null===e||void 0===e?void 0:e.labels;if(v){const e=y().findIndex(v,(e=>null!==e&&"ai.backend.customized-image.name"===(null===e||void 0===e?void 0:e.key)));if(e&&v[e]){var g;const n=(null===(g=v[e])||void 0===g?void 0:g.value)||"";d.push("Customized"),d.push(n),u.push((0,_.jsx)(o.A,{values:[{label:(0,_.jsx)(m.A,{keyword:N,children:"Customized"},"Customized"),color:"cyan"},{label:(0,_.jsx)(m.A,{keyword:N,children:n},n),color:"cyan"}]},u.length+1))}}return(0,_.jsx)(c.A.Option,{value:(0,l.A_)(e),filterValue:[i,s,null===e||void 0===e?void 0:e.architecture,...d].join("\t"),children:(0,_.jsxs)(r.A,{direction:"row",justify:"between",children:[(0,_.jsxs)(r.A,{direction:"row",children:[(0,_.jsx)(m.A,{keyword:N,children:i}),(0,_.jsx)(p.A,{type:"vertical"}),(0,_.jsx)(m.A,{keyword:N,children:s}),(0,_.jsx)(p.A,{type:"vertical"}),(0,_.jsx)(m.A,{keyword:N,children:null===e||void 0===e?void 0:e.architecture})]}),(0,_.jsx)(r.A,{direction:"row",className:M?"tag-wrap-dark":"tag-wrap-light",style:{marginLeft:C.marginXS,flexShrink:1},children:u||"-"})]})},null===e||void 0===e?void 0:e.digest)}))})})}}),(0,_.jsx)(u.A.Item,{label:V("session.launcher.ManualImageName"),name:["environments","manual"],style:{display:b._config.allow_manual_image_name_for_session?"block":"none"},children:(0,_.jsx)(h.A,{allowClear:!0,onChange:e=>{y().isEmpty(e)||w.setFieldsValue({environments:{environment:void 0,version:void 0,image:void 0}})}})}),(0,_.jsx)(u.A.Item,{noStyle:!0,hidden:!0,name:["environments","image"],children:(0,_.jsx)(h.A,{})})]})}},5739:(e,n,i)=>{i.r(n),i.d(n,{default:()=>a});const l=function(){var e=[{defaultValue:null,kind:"LocalArgument",name:"installed"}],n={alias:null,args:null,kind:"ScalarField",name:"key",storageKey:null},i=[{alias:null,args:[{kind:"Variable",name:"is_installed",variableName:"installed"}],concreteType:"Image",kind:"LinkedField",name:"images",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"name",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"humanized_name",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"tag",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"registry",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"architecture",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"digest",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"installed",storageKey:null},{alias:null,args:null,concreteType:"ResourceLimit",kind:"LinkedField",name:"resource_limits",plural:!0,selections:[n,{alias:null,args:null,kind:"ScalarField",name:"min",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"max",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"KVPair",kind:"LinkedField",name:"labels",plural:!0,selections:[n,{alias:null,args:null,kind:"ScalarField",name:"value",storageKey:null}],storageKey:null}],storageKey:null}];return{fragment:{argumentDefinitions:e,kind:"Fragment",metadata:null,name:"ImageEnvironmentSelectFormItemsQuery",selections:i,type:"Queries",abstractKey:null},kind:"Request",operation:{argumentDefinitions:e,kind:"Operation",name:"ImageEnvironmentSelectFormItemsQuery",selections:i},params:{cacheID:"ea71f4a3948d4742dd6bb11ef80a8300",id:null,metadata:{},name:"ImageEnvironmentSelectFormItemsQuery",operationKind:"query",text:"query ImageEnvironmentSelectFormItemsQuery(\n  $installed: Boolean\n) {\n  images(is_installed: $installed) {\n    name\n    humanized_name\n    tag\n    registry\n    architecture\n    digest\n    installed\n    resource_limits {\n      key\n      min\n      max\n    }\n    labels {\n      key\n      value\n    }\n  }\n}\n"}}}();l.hash="33367bd6e1532b42b61629ef9d3dc46b";const a=l}}]);
//# sourceMappingURL=676.62e0b671.chunk.js.map