"use strict";(self.webpackChunkbackend_ai_webui_react=self.webpackChunkbackend_ai_webui_react||[]).push([[7569],{27569:(e,a,l)=>{l.r(a),l.d(a,{default:()=>b,useFileUploadManager:()=>N});const n=function(){var e=[{defaultValue:null,kind:"LocalArgument",name:"vfolderGlobalId"}],a=[{kind:"Variable",name:"id",variableName:"vfolderGlobalId"}],l={alias:null,args:null,kind:"ScalarField",name:"name",storageKey:null};return{fragment:{argumentDefinitions:e,kind:"Fragment",metadata:null,name:"FileUploadManagerQuery",selections:[{alias:null,args:a,concreteType:"VirtualFolderNode",kind:"LinkedField",name:"vfolder_node",plural:!1,selections:[{kind:"RequiredField",field:l,action:"THROW"}],storageKey:null}],type:"Query",abstractKey:null},kind:"Request",operation:{argumentDefinitions:e,kind:"Operation",name:"FileUploadManagerQuery",selections:[{alias:null,args:a,concreteType:"VirtualFolderNode",kind:"LinkedField",name:"vfolder_node",plural:!1,selections:[l,{alias:null,args:null,kind:"ScalarField",name:"id",storageKey:null}],storageKey:null}]},params:{cacheID:"da162cec4ce77cdb6fcdd31a87d2f135",id:null,metadata:{},name:"FileUploadManagerQuery",operationKind:"query",text:"query FileUploadManagerQuery(\n  $vfolderGlobalId: String!\n) {\n  vfolder_node(id: $vfolderGlobalId) {\n    name\n    id\n  }\n}\n"}}}();n.hash="1f3a6bd97dae542b3c85605ab9a61d03";const o=n;var d=l(82860),r=l(63872),i=l(64949),t=l(81501),s=l(17315),u=l(8348),c=l.n(u),p=l(97190),m=l(66610),v=l(54070),f=l(89737),g=l(19885),F=l(29951);const k=(0,i.eU)([]),y=(0,i.eU)({}),h=(0,s.Iz)((e=>(0,i.eU)((a=>a(y)[e]),((a,l,n)=>{const o=a(y);l(y,{...o,[e]:n})})))),b=()=>{const{t:e}=(0,v.Bd)(),{upsertNotification:a}=(0,d.js)(),l=(0,g.CX)(),[n,o]=(0,t.fp)(k),[r,i]=(0,t.fp)(y),s=new p.A({concurrency:1});return(0,m.useEffect)((()=>{0!==n.length&&l&&(n.forEach((l=>{const{vFolderId:n,vFolderName:o,uploadFilesNames:d,startFunctions:r}=l;i((e=>{var a;return{...e,[n]:{vFolderName:o,pending:[...(null===(a=e[n])||void 0===a?void 0:a.pending)||[],...d],completed:[],failed:[]}}})),a({key:"upload:"+n,open:!0,message:e("explorer.UploadToFolder",{folderName:o}),backgroundTask:{status:"pending",percent:0,onChange:{pending:e("explorer.ProcessingUpload")}},duration:0}),r.forEach((l=>{s.add((async()=>{await l({onProgress:(l,d,r)=>{i((i=>{var t;const s=(null===(t=i[n])||void 0===t?void 0:t.pending)||[];return a({key:"upload:"+n,message:`${e("explorer.UploadToFolder",{folderName:o})}${s.length>1?` (${s.length})`:""}`,backgroundTask:{status:"pending",percent:Math.round(l/d*100)-1,onChange:{pending:e("explorer.FileInProgress",{fileName:r})}}}),i}))}}).then((e=>{i((a=>({...a,[n]:{...a[n],pending:a[n].pending.filter((a=>a!==e)),completed:[...a[n].completed,e]}})))})).catch((e=>{i((a=>({...a,[n]:{...a[n],pending:a[n].pending.filter((a=>a!==e)),failed:[...a[n].failed,e]}})))}))}))}))})),o([]))}),[n]),(0,m.useEffect)((()=>{Object.entries(r).forEach((l=>{let[n,o]=l;c().isEmpty(null===o||void 0===o?void 0:o.pending)&&(c().isEmpty(null===o||void 0===o?void 0:o.failed)?c().isEmpty(null===o||void 0===o?void 0:o.completed)||(a({key:"upload:"+n,open:!0,message:e("explorer.SuccessfullyUploadedToFolder",{folderName:null===o||void 0===o?void 0:o.vFolderName}),backgroundTask:{status:"resolved",percent:100,onChange:{resolved:" "}},duration:3}),i((e=>({...e,[n]:{...e[n],completed:[]}})))):a({key:"upload:"+n,open:!0,message:e("explorer.UploadFailed",{folderName:null===o||void 0===o?void 0:o.vFolderName}),backgroundTask:{status:"rejected",percent:0,onChange:{rejected:e("explorer.FileUploadFailed",{folderName:null===o||void 0===o?void 0:o.vFolderName})}},extraDescription:c().join(null===o||void 0===o?void 0:o.failed,", ")}))}))}),[r]),null},N=e=>{const a=(0,r.kq)(),{t:l}=(0,v.Bd)(),{upsertNotification:n}=(0,d.js)(),[i,s]=(e=>(0,t.fp)(h(e)))(e),u=(0,t.Xr)(k),{vfolder_node:p}=(0,f.useLazyLoadQuery)(o,{vfolderGlobalId:(0,r.wc)("VirtualFolderNode",e)},{fetchPolicy:e?"network-only":"store-only"});return{uploadStatus:i,setUploadStatus:s,uploadFiles:async(e,o,d)=>{var r;if(!((e,o)=>{const d=a._config.maxFileUploadSize,r=c().map(e,(e=>e.size)).reduce(((e,a)=>Math.max(e,a)),0);var i;return!(d>0&&r>d)||(n({open:!0,key:"upload:"+o,message:l("explorer.UploadFailed",{folderName:null!==(i=null===p||void 0===p?void 0:p.name)&&void 0!==i?i:""}),description:l("data.explorer.FileUploadSizeLimit"),duration:3,toText:l("data.folders.OpenAFolder"),to:{search:new URLSearchParams({folder:o}).toString()}}),!1)})(e,o))return;let i=[];const t=c().map(e,(e=>(i.push(e.webkitRelativePath||e.name),async l=>{const n=[d,e.webkitRelativePath||e.name].filter(Boolean).join("/"),r=await a.vfolder.create_upload_session(n,e,o);return new Promise(((a,n)=>{new F._O(e,{endpoint:r,uploadUrl:r,retryDelays:[0,3e3,5e3,1e4,2e4],chunkSize:U(e.size),storeFingerprintForResuming:!1,metadata:{filename:e.name,filetype:e.type},onProgress:(a,n)=>{var o;null===l||void 0===l||null===(o=l.onProgress)||void 0===o||o.call(l,a,n,e.name)},onSuccess:()=>{a(e.webkitRelativePath||e.name)},onError:()=>{n(e.webkitRelativePath||e.name)}}).start()}))}))),s={vFolderId:o,vFolderName:null!==(r=null===p||void 0===p?void 0:p.name)&&void 0!==r?r:"",uploadFilesNames:i,startFunctions:t};u((e=>[...e,s]))}}},U=e=>{const a=1048576;return e>=5120*a?200*a:e>=1024*a?100*a:e>=100*a?50*a:15*a}}}]);
//# sourceMappingURL=7569.2bdff2ca.chunk.js.map