"use strict";(self.webpackChunkbackend_ai_webui_react=self.webpackChunkbackend_ai_webui_react||[]).push([[7569],{27569:(e,l,n)=>{n.r(l),n.d(l,{default:()=>z,useFileUploadManager:()=>E});const o=function(){var e=[{defaultValue:null,kind:"LocalArgument",name:"vfolderGlobalId"}],l=[{kind:"Variable",name:"id",variableName:"vfolderGlobalId"}],n={alias:null,args:null,kind:"ScalarField",name:"name",storageKey:null};return{fragment:{argumentDefinitions:e,kind:"Fragment",metadata:null,name:"FileUploadManagerQuery",selections:[{alias:null,args:l,concreteType:"VirtualFolderNode",kind:"LinkedField",name:"vfolder_node",plural:!1,selections:[{kind:"RequiredField",field:n,action:"THROW"}],storageKey:null}],type:"Query",abstractKey:null},kind:"Request",operation:{argumentDefinitions:e,kind:"Operation",name:"FileUploadManagerQuery",selections:[{alias:null,args:l,concreteType:"VirtualFolderNode",kind:"LinkedField",name:"vfolder_node",plural:!1,selections:[n,{alias:null,args:null,kind:"ScalarField",name:"id",storageKey:null}],storageKey:null}]},params:{cacheID:"da162cec4ce77cdb6fcdd31a87d2f135",id:null,metadata:{},name:"FileUploadManagerQuery",operationKind:"query",text:"query FileUploadManagerQuery(\n  $vfolderGlobalId: String!\n) {\n  vfolder_node(id: $vfolderGlobalId) {\n    name\n    id\n  }\n}\n"}}}();o.hash="1f3a6bd97dae542b3c85605ab9a61d03";const i=o;var a=n(1394),t=n(30167),d=n(28299),r=n(68144),s=n(28599),u=n(91313),c=n(85395),p=n(23403),v=n(66033),m=n(8348),f=n.n(m),F=n(35543),g=n(84100),y=n(81291),h=n(85724),k=n(19885),x=n(2212),b=n(29951),w=n(7960);const S=(0,c.eU)([]),U=(0,c.eU)({}),_=(0,v.Iz)((e=>(0,c.eU)((l=>l(U)[e]),((l,n,o)=>{const i=l(U);n(U,{...i,[e]:o})})))),z=()=>{const{t:e}=(0,y.Bd)(),{token:l}=r.A.useToken(),n=(0,k.CX)(),{upsertNotification:o,destroyNotification:i}=(0,t.js)(),{generateFolderPath:a}=(0,d.useFolderExplorerOpener)(),[c,v]=(0,p.fp)(S),[m,h]=(0,p.fp)(U),[b]=(0,x.q)("max_concurrent_uploads"),_=new F.A({concurrency:b||2}),z=(0,g.useRef)({}),E=f().throttle(((n,i)=>{const a=z.current[n]||0;z.current[n]=0,h((t=>{var d,r,c,p,v,m,f,F,g,y;const h=(null===(d=t[n])||void 0===d||null===(r=d.completedFiles)||void 0===r?void 0:r.length)||0,k=((null===(c=t[n])||void 0===c||null===(p=c.completedFiles)||void 0===p?void 0:p.length)||0)+((null===(v=t[n])||void 0===v||null===(m=v.failedFiles)||void 0===m?void 0:m.length)||0)+((null===(f=t[n])||void 0===f||null===(F=f.pendingFiles)||void 0===F?void 0:F.length)||0),x=(null===(g=t[n])||void 0===g?void 0:g.totalExpectedSize)||0,b=((null===(y=t[n])||void 0===y?void 0:y.completedBytes)||0)+a;return o({key:"upload:"+n,backgroundTask:{status:"pending",percent:x>0?b/x*100:0,onChange:{pending:{description:(0,w.jsxs)(u.OO,{direction:"column",align:"start",children:[(0,w.jsxs)(s.A.Text,{children:[e("explorer.UploadingFiles")," ( ",h," /"," ",k," )"]}),(0,w.jsx)(s.A.Text,{ellipsis:!0,type:"secondary",style:{fontSize:l.fontSizeSM,maxWidth:"300px"},children:i})]})}}}}),{...t,[n]:{...t[n],completedBytes:b}}}))}),200,{leading:!0,trailing:!0});return(0,g.useEffect)((()=>{0!==c.length&&n&&(c.forEach((l=>{const{vFolderId:n,vFolderName:t,uploadFileInfo:d}=l,r=f().sumBy(d,(e=>e.file.size));h((l=>{var s,c,p,v,m,f;const F=!l[n],g=((null===(s=l[n])||void 0===s?void 0:s.totalExpectedSize)||0)+r,y=F?0:((null===(c=l[n])||void 0===c?void 0:c.completedBytes)||0)/g*100;return o({key:"upload:"+n,open:!0,message:(0,w.jsxs)("span",{children:[e("explorer.VFolder"),":\xa0",(0,w.jsx)(u.rm,{style:{fontWeight:"normal"},to:a(n),onClick:()=>{i("upload:"+n)},children:`${t}`})]}),backgroundTask:{status:"pending",percent:y,onChange:{pending:e("explorer.ProcessingUpload")}},duration:0}),{...l,[n]:{vFolderName:t,pendingFiles:[...(null===(p=l[n])||void 0===p?void 0:p.pendingFiles)||[],...d.map((e=>e.file.webkitRelativePath||e.file.name))],completedFiles:(null===(v=l[n])||void 0===v?void 0:v.completedFiles)||[],failedFiles:(null===(m=l[n])||void 0===m?void 0:m.failedFiles)||[],completedBytes:(null===(f=l[n])||void 0===f?void 0:f.completedBytes)||0,totalExpectedSize:g}}})),d.forEach((e=>{let{file:l,startFunction:o}=e;_.add((async()=>{const e=l.webkitRelativePath||l.name;let i=0;try{await o({onProgress:(e,l,o)=>{const a=e-i;i=e,z.current[n]=(z.current[n]||0)+a,E(n,o)}}),E.flush(),delete z.current[n],h((l=>{var o;return{...l,[n]:{...l[n],pendingFiles:l[n].pendingFiles.filter((l=>l!==e)),completedFiles:[...(null===(o=l[n])||void 0===o?void 0:o.completedFiles)||[],e]}}}))}catch(a){E.flush(),delete z.current[n],h((l=>{var o;return{...l,[n]:{...l[n],pendingFiles:l[n].pendingFiles.filter((l=>l!==e)),failedFiles:[...(null===(o=l[n])||void 0===o?void 0:o.failedFiles)||[],e]}}}))}}))}))})),v([]))}),[c]),(0,g.useEffect)((()=>{Object.entries(m).forEach((l=>{let[n,t]=l;f().isEmpty(null===t||void 0===t?void 0:t.pendingFiles)&&(f().isEmpty(null===t||void 0===t?void 0:t.failedFiles)?f().isEmpty(null===t||void 0===t?void 0:t.completedFiles)||(o({key:"upload:"+n,open:!0,message:(0,w.jsxs)("span",{children:[e("explorer.VFolder"),":\xa0",(0,w.jsx)(u.rm,{style:{fontWeight:"normal"},to:a(n),onClick:()=>{i("upload:"+n)},children:`${null===t||void 0===t?void 0:t.vFolderName}`})]}),backgroundTask:{status:"resolved",percent:100,onChange:{resolved:e("explorer.SuccessfullyUploadedToFolder")}},duration:3}),h((e=>({...e,[n]:{...e[n],completedFiles:[],completedBytes:0,totalExpectedSize:0}})))):o({key:"upload:"+n,open:!0,message:e("explorer.UploadFailed",{folderName:null===t||void 0===t?void 0:t.vFolderName}),backgroundTask:{status:"rejected",percent:0,onChange:{rejected:e("explorer.FileUploadFailed",{folderName:null===t||void 0===t?void 0:t.vFolderName})}},extraDescription:f().join(null===t||void 0===t?void 0:t.failedFiles,", ")}))}))}),[m]),null},E=e=>{const l=(0,a.c)(21),n=(0,u.kq)(),{t:o}=(0,y.Bd)(),{upsertNotification:d}=(0,t.js)(),[r,s]=(e=>(0,p.fp)(_(e)))(e),c=(0,p.Xr)(S);let v,m,F;l[0]===Symbol.for("react.memo_cache_sentinel")?(v=i,l[0]=v):v=l[0],l[1]!==e?(m=(0,u.wc)("VirtualFolderNode",e),l[1]=e,l[2]=m):m=l[2],l[3]!==m?(F={vfolderGlobalId:m},l[3]=m,l[4]=F):F=l[4];const g=e?"network-only":"store-only";let k;l[5]!==g?(k={fetchPolicy:g},l[5]=g,l[6]=k):k=l[6];const{vfolder_node:x}=(0,h.useLazyLoadQuery)(v,F,k);let w;l[7]!==n||l[8]!==o||l[9]!==d||l[10]!==(null===x||void 0===x?void 0:x.name)?(w=(e,l)=>{const i=n._config.maxFileUploadSize,a=f().map(e,j).reduce(T,0);var t;return!(i>0&&a>i)||(d({open:!0,key:"upload:"+l,message:o("explorer.UploadFailed",{folderName:null!==(t=null===x||void 0===x?void 0:x.name)&&void 0!==t?t:""}),description:o("data.explorer.FileUploadSizeLimit"),duration:3,toText:o("data.folders.OpenAFolder"),to:{search:new URLSearchParams({folder:l}).toString()}}),!1)},l[7]=n,l[8]=o,l[9]=d,l[10]=null===x||void 0===x?void 0:x.name,l[11]=w):w=l[11];const U=w;let z;l[12]!==n||l[13]!==c||l[14]!==U||l[15]!==(null===x||void 0===x?void 0:x.name)?(z=async(e,l,o)=>{var i;if(!U(e,l))return;const a=[],t=f().map(e,(e=>(a.push(e),async i=>{const a=e.webkitRelativePath||e.name;try{const t=[o,a].filter(Boolean).join("/"),d=await n.vfolder.create_upload_session(t,e,l);return await new Promise(((l,n)=>{try{new b._O(e,{endpoint:d,uploadUrl:d,retryDelays:[0,3e3,5e3,1e4,2e4],chunkSize:N(e.size),storeFingerprintForResuming:!1,metadata:{filename:e.name,filetype:e.type},onProgress:(e,l)=>{var n;null===i||void 0===i||null===(n=i.onProgress)||void 0===n||n.call(i,e,l,a)},onSuccess:()=>{l({name:a,bytes:e.size})},onError:e=>{n(new Error(`Upload failed for ${a}`))}}).start()}catch(o){n(new Error(`Failed to initialize upload for ${a}`))}}))}catch(P){throw new Error(`Failed to prepare upload for ${a}`)}}))),d={vFolderId:l,vFolderName:null!==(i=null===x||void 0===x?void 0:x.name)&&void 0!==i?i:"",uploadFileInfo:f().zipWith(a,t,I)};c((e=>[...e,d]))},l[12]=n,l[13]=c,l[14]=U,l[15]=null===x||void 0===x?void 0:x.name,l[16]=z):z=l[16];const E=z;let P;return l[17]!==s||l[18]!==E||l[19]!==r?(P={uploadStatus:r,setUploadStatus:s,uploadFiles:E},l[17]=s,l[18]=E,l[19]=r,l[20]=P):P=l[20],P},N=e=>{const l=1048576;return e>=5120*l?200*l:e>=1024*l?100*l:e>=100*l?50*l:15*l};function j(e){return e.size}function T(e,l){return Math.max(e,l)}function I(e,l){return{file:e,startFunction:l}}}}]);
//# sourceMappingURL=7569.ec17f12c.chunk.js.map