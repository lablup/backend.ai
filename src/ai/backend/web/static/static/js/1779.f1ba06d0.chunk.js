"use strict";(self.webpackChunkbackend_ai_webui_react=self.webpackChunkbackend_ai_webui_react||[]).push([[1779],{44160:(e,l,o)=>{o.r(l),o.d(l,{default:()=>z,useFileUploadManager:()=>S});var t=o(56276),n=o(39120),i=o(86167),r=o(66800),d=o(76591),a=o(96223),s=o(67631),c=o(86980),u=o(51440),p=o(79410),v=o(47699),f=o.n(v),m=o(77183),F=o(17534),g=o(62962),h=o(40690),y=o(10979),x=o(14172),k=o(89374);const A=(0,c.eU)([]),w=(0,c.eU)({}),E=(0,p.Iz)((e=>(0,c.eU)((l=>l(w)[e]),((l,o,n)=>{const i=l(w);o(w,(0,t.A)((0,t.A)({},i),{},{[e]:n}))})))),z=()=>{const{t:e}=(0,g.Bd)(),{token:l}=d.A.useToken(),o=(0,h.CX)(),{upsertNotification:n,closeNotification:c}=(0,i.js)(),{generateFolderPath:p}=(0,r.useFolderExplorerOpener)(),[v,x]=(0,u.fp)(A),[E,z]=(0,u.fp)(w),[S]=(0,y.q)("max_concurrent_uploads"),U=new m.A({concurrency:S||2}),b=(0,F.useRef)({}),j=f().throttle(((o,i)=>{const r=b.current[o]||0;b.current[o]=0,z((d=>{var c,u,p,v,f,m,F,g,h,y;const x=(null===(c=d[o])||void 0===c||null===(u=c.completedFiles)||void 0===u?void 0:u.length)||0,A=((null===(p=d[o])||void 0===p||null===(v=p.completedFiles)||void 0===v?void 0:v.length)||0)+((null===(f=d[o])||void 0===f||null===(m=f.failedFiles)||void 0===m?void 0:m.length)||0)+((null===(F=d[o])||void 0===F||null===(g=F.pendingFiles)||void 0===g?void 0:g.length)||0),w=(null===(h=d[o])||void 0===h?void 0:h.totalExpectedSize)||0,E=((null===(y=d[o])||void 0===y?void 0:y.completedBytes)||0)+r;return n({key:"upload:"+o,backgroundTask:{status:"pending",percent:w>0?E/w*100:0,onChange:{pending:{description:(0,k.jsxs)(s.OO,{direction:"column",align:"start",children:[(0,k.jsxs)(a.A.Text,{children:[e("explorer.UploadingFiles")," ( ",x," /"," ",A," )"]}),(0,k.jsx)(a.A.Text,{ellipsis:!0,type:"secondary",style:{fontSize:l.fontSizeSM,maxWidth:"300px"},children:i})]})}}}}),(0,t.A)((0,t.A)({},d),{},{[o]:(0,t.A)((0,t.A)({},d[o]),{},{completedBytes:E})})}))}),200,{leading:!0,trailing:!0});return(0,F.useEffect)((()=>{0!==v.length&&o&&(v.forEach((l=>{const{vFolderId:o,vFolderName:i,uploadFileInfo:r}=l,d=f().sumBy(r,(e=>e.file.size));z((l=>{var a,u,v,f,m,F;const g=!l[o],h=((null===(a=l[o])||void 0===a?void 0:a.totalExpectedSize)||0)+d,y=g?0:((null===(u=l[o])||void 0===u?void 0:u.completedBytes)||0)/h*100;return n({key:"upload:"+o,open:!0,message:(0,k.jsxs)("span",{children:[e("explorer.VFolder"),":\xa0",(0,k.jsx)(s.rm,{style:{fontWeight:"normal"},to:p(o),onClick:()=>{c("upload:"+o)},children:"".concat(i)})]}),backgroundTask:{status:"pending",percent:y,onChange:{pending:e("explorer.ProcessingUpload")}},duration:0}),(0,t.A)((0,t.A)({},l),{},{[o]:{vFolderName:i,pendingFiles:[...(null===(v=l[o])||void 0===v?void 0:v.pendingFiles)||[],...r.map((e=>e.file.webkitRelativePath||e.file.name))],completedFiles:(null===(f=l[o])||void 0===f?void 0:f.completedFiles)||[],failedFiles:(null===(m=l[o])||void 0===m?void 0:m.failedFiles)||[],completedBytes:(null===(F=l[o])||void 0===F?void 0:F.completedBytes)||0,totalExpectedSize:h}})})),r.forEach((e=>{let{file:l,startFunction:n}=e;U.add((async()=>{const e=l.webkitRelativePath||l.name;let i=0;try{await n({onProgress:(e,l,t)=>{const n=e-i;i=e,b.current[o]=(b.current[o]||0)+n,j(o,t)}}),j.flush(),delete b.current[o],z((l=>{var n;return(0,t.A)((0,t.A)({},l),{},{[o]:(0,t.A)((0,t.A)({},l[o]),{},{pendingFiles:l[o].pendingFiles.filter((l=>l!==e)),completedFiles:[...(null===(n=l[o])||void 0===n?void 0:n.completedFiles)||[],e]})})}))}catch(r){j.flush(),delete b.current[o],z((l=>{var n;return(0,t.A)((0,t.A)({},l),{},{[o]:(0,t.A)((0,t.A)({},l[o]),{},{pendingFiles:l[o].pendingFiles.filter((l=>l!==e)),failedFiles:[...(null===(n=l[o])||void 0===n?void 0:n.failedFiles)||[],e]})})}))}}))}))})),x([]))}),[v]),(0,F.useEffect)((()=>{Object.entries(E).forEach((l=>{let[o,i]=l;f().isEmpty(null===i||void 0===i?void 0:i.pendingFiles)&&(f().isEmpty(null===i||void 0===i?void 0:i.failedFiles)?f().isEmpty(null===i||void 0===i?void 0:i.completedFiles)||(n({key:"upload:"+o,open:!0,message:(0,k.jsxs)("span",{children:[e("explorer.VFolder"),":\xa0",(0,k.jsx)(s.rm,{style:{fontWeight:"normal"},to:p(o),onClick:()=>{c("upload:"+o)},children:"".concat(null===i||void 0===i?void 0:i.vFolderName)})]}),backgroundTask:{status:"resolved",percent:100,onChange:{resolved:e("explorer.SuccessfullyUploadedToFolder")}},duration:3}),z((e=>(0,t.A)((0,t.A)({},e),{},{[o]:(0,t.A)((0,t.A)({},e[o]),{},{completedFiles:[],completedBytes:0,totalExpectedSize:0})})))):n({key:"upload:"+o,open:!0,message:e("explorer.UploadFailed",{folderName:null===i||void 0===i?void 0:i.vFolderName}),backgroundTask:{status:"rejected",percent:0,onChange:{rejected:e("explorer.FileUploadFailed",{folderName:null===i||void 0===i?void 0:i.vFolderName})}},extraDescription:f().join(null===i||void 0===i?void 0:i.failedFiles,", ")}))}))}),[E]),null},S=(e,l)=>{const o=(0,n.c)(16),t=(0,s.kq)(),{t:r}=(0,g.Bd)(),{upsertNotification:d}=(0,i.js)(),a=(0,u.Xr)(A);let c;o[0]!==e?(c=e?(0,s.om)(e).replace(/-/g,""):"",o[0]=e,o[1]=c):c=o[1];const[p,v]=(m=c,(0,u.fp)(E(m)));var m;let F;o[2]!==t||o[3]!==l||o[4]!==r||o[5]!==d?(F=(e,o)=>{const n=t._config.maxFileUploadSize,i=f().map(e,b).reduce(j,0);return!(n>0&&i>n)||(d({open:!0,key:"upload:"+o,message:r("explorer.UploadFailed",{folderName:null!==l&&void 0!==l?l:""}),description:r("data.explorer.FileUploadSizeLimit"),duration:3,toText:r("data.folders.OpenAFolder"),to:{search:new URLSearchParams({folder:o}).toString()}}),!1)},o[2]=t,o[3]=l,o[4]=r,o[5]=d,o[6]=F):F=o[6];const h=F;let y;o[7]!==t||o[8]!==l||o[9]!==a||o[10]!==h?(y=async(e,o,n)=>{if(!h(e,o))return;const i=[],r=f().map(e,(e=>(i.push(e),async l=>{const i=e.webkitRelativePath||e.name;try{const r=[n,i].filter(Boolean).join("/"),d=await t.vfolder.create_upload_session(r,e,o);return await new Promise(((o,t)=>{try{new x._O(e,{endpoint:d,uploadUrl:d,retryDelays:[0,3e3,5e3,1e4,2e4],chunkSize:U(e.size),storeFingerprintForResuming:!1,metadata:{filename:e.name,filetype:e.type},onProgress:(e,o)=>{var t;null===l||void 0===l||null===(t=l.onProgress)||void 0===t||t.call(l,e,o,i)},onSuccess:()=>{o({name:i,bytes:e.size})},onError:e=>{t(new Error("Upload failed for ".concat(i)))}}).start()}catch(n){t(new Error("Failed to initialize upload for ".concat(i)))}}))}catch(w){throw new Error("Failed to prepare upload for ".concat(i))}}))),d={vFolderId:o,vFolderName:null!==l&&void 0!==l?l:"",uploadFileInfo:f().zipWith(i,r,N)};a((e=>[...e,d]))},o[7]=t,o[8]=l,o[9]=a,o[10]=h,o[11]=y):y=o[11];const k=y;let w;return o[12]!==v||o[13]!==k||o[14]!==p?(w={uploadStatus:p,setUploadStatus:v,uploadFiles:k},o[12]=v,o[13]=k,o[14]=p,o[15]=w):w=o[15],w},U=e=>{const l=1048576;return e>=5120*l?200*l:e>=1024*l?100*l:e>=100*l?50*l:15*l};function b(e){return e.size}function j(e,l){return Math.max(e,l)}function N(e,l){return{file:e,startFunction:l}}}}]);
//# sourceMappingURL=1779.f1ba06d0.chunk.js.map