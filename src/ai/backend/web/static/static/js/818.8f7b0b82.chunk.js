"use strict";(self.webpackChunkbackend_ai_webui_react=self.webpackChunkbackend_ai_webui_react||[]).push([[818],{30818:(e,l,o)=>{o.r(l),o.d(l,{default:()=>z,useFileUploadManager:()=>S});var t=o(40005),n=o(41633),i=o(18302),r=o(234),d=o(8334),a=o(45045),s=o(23370),c=o(39758),u=o(48200),p=o(43749),v=o.n(p),f=o(75334),m=o(21481),F=o(51569),g=o(43224),h=o(497),y=o(6620),x=o(66845);const k=(0,s.eU)([]),w=(0,s.eU)({}),E=(0,u.Iz)((e=>(0,s.eU)((l=>l(w)[e]),((l,o,t)=>{const n=l(w);o(w,{...n,[e]:t})})))),z=()=>{const{t:e}=(0,F.Bd)(),{token:l}=r.A.useToken(),o=(0,g.CX)(),{upsertNotification:t,closeNotification:s}=(0,n.js)(),{generateFolderPath:u}=(0,i.useFolderExplorerOpener)(),[p,y]=(0,c.fp)(k),[E,z]=(0,c.fp)(w),[S]=(0,h.q)("max_concurrent_uploads"),U=new f.A({concurrency:S||2}),b=(0,m.useRef)({}),j=v().throttle(((o,n)=>{const i=b.current[o]||0;b.current[o]=0,z((r=>{var s,c,u,p,v,f,m,F,g,h;const y=(null===(s=r[o])||void 0===s||null===(c=s.completedFiles)||void 0===c?void 0:c.length)||0,k=((null===(u=r[o])||void 0===u||null===(p=u.completedFiles)||void 0===p?void 0:p.length)||0)+((null===(v=r[o])||void 0===v||null===(f=v.failedFiles)||void 0===f?void 0:f.length)||0)+((null===(m=r[o])||void 0===m||null===(F=m.pendingFiles)||void 0===F?void 0:F.length)||0),w=(null===(g=r[o])||void 0===g?void 0:g.totalExpectedSize)||0,E=((null===(h=r[o])||void 0===h?void 0:h.completedBytes)||0)+i;return t({key:"upload:"+o,backgroundTask:{status:"pending",percent:w>0?E/w*100:0,onChange:{pending:{description:(0,x.jsxs)(a.OO,{direction:"column",align:"start",children:[(0,x.jsxs)(d.A.Text,{children:[e("explorer.UploadingFiles")," ( ",y," /"," ",k," )"]}),(0,x.jsx)(d.A.Text,{ellipsis:!0,type:"secondary",style:{fontSize:l.fontSizeSM,maxWidth:"300px"},children:n})]})}}}}),{...r,[o]:{...r[o],completedBytes:E}}}))}),200,{leading:!0,trailing:!0});return(0,m.useEffect)((()=>{0!==p.length&&o&&(p.forEach((l=>{const{vFolderId:o,vFolderName:n,uploadFileInfo:i}=l,r=v().sumBy(i,(e=>e.file.size));z((l=>{var d,c,p,v,f,m;const F=!l[o],g=((null===(d=l[o])||void 0===d?void 0:d.totalExpectedSize)||0)+r,h=F?0:((null===(c=l[o])||void 0===c?void 0:c.completedBytes)||0)/g*100;return t({key:"upload:"+o,open:!0,message:(0,x.jsxs)("span",{children:[e("explorer.VFolder"),":\xa0",(0,x.jsx)(a.rm,{style:{fontWeight:"normal"},to:u(o),onClick:()=>{s("upload:"+o)},children:`${n}`})]}),backgroundTask:{status:"pending",percent:h,onChange:{pending:e("explorer.ProcessingUpload")}},duration:0}),{...l,[o]:{vFolderName:n,pendingFiles:[...(null===(p=l[o])||void 0===p?void 0:p.pendingFiles)||[],...i.map((e=>e.file.webkitRelativePath||e.file.name))],completedFiles:(null===(v=l[o])||void 0===v?void 0:v.completedFiles)||[],failedFiles:(null===(f=l[o])||void 0===f?void 0:f.failedFiles)||[],completedBytes:(null===(m=l[o])||void 0===m?void 0:m.completedBytes)||0,totalExpectedSize:g}}})),i.forEach((e=>{let{file:l,startFunction:t}=e;U.add((async()=>{const e=l.webkitRelativePath||l.name;let n=0;try{await t({onProgress:(e,l,t)=>{const i=e-n;n=e,b.current[o]=(b.current[o]||0)+i,j(o,t)}}),j.flush(),delete b.current[o],z((l=>{var t;return{...l,[o]:{...l[o],pendingFiles:l[o].pendingFiles.filter((l=>l!==e)),completedFiles:[...(null===(t=l[o])||void 0===t?void 0:t.completedFiles)||[],e]}}}))}catch(i){j.flush(),delete b.current[o],z((l=>{var t;return{...l,[o]:{...l[o],pendingFiles:l[o].pendingFiles.filter((l=>l!==e)),failedFiles:[...(null===(t=l[o])||void 0===t?void 0:t.failedFiles)||[],e]}}}))}}))}))})),y([]))}),[p]),(0,m.useEffect)((()=>{Object.entries(E).forEach((l=>{let[o,n]=l;v().isEmpty(null===n||void 0===n?void 0:n.pendingFiles)&&(v().isEmpty(null===n||void 0===n?void 0:n.failedFiles)?v().isEmpty(null===n||void 0===n?void 0:n.completedFiles)||(t({key:"upload:"+o,open:!0,message:(0,x.jsxs)("span",{children:[e("explorer.VFolder"),":\xa0",(0,x.jsx)(a.rm,{style:{fontWeight:"normal"},to:u(o),onClick:()=>{s("upload:"+o)},children:`${null===n||void 0===n?void 0:n.vFolderName}`})]}),backgroundTask:{status:"resolved",percent:100,onChange:{resolved:e("explorer.SuccessfullyUploadedToFolder")}},duration:3}),z((e=>({...e,[o]:{...e[o],completedFiles:[],completedBytes:0,totalExpectedSize:0}})))):t({key:"upload:"+o,open:!0,message:e("explorer.UploadFailed",{folderName:null===n||void 0===n?void 0:n.vFolderName}),backgroundTask:{status:"rejected",percent:0,onChange:{rejected:e("explorer.FileUploadFailed",{folderName:null===n||void 0===n?void 0:n.vFolderName})}},extraDescription:v().join(null===n||void 0===n?void 0:n.failedFiles,", ")}))}))}),[E]),null},S=(e,l)=>{const o=(0,t.c)(16),i=(0,a.kq)(),{t:r}=(0,F.Bd)(),{upsertNotification:d}=(0,n.js)(),s=(0,c.Xr)(k);let u;o[0]!==e?(u=e?(0,a.om)(e):"",o[0]=e,o[1]=u):u=o[1];const[p,f]=(m=u,(0,c.fp)(E(m)));var m;let g;o[2]!==i||o[3]!==l||o[4]!==r||o[5]!==d?(g=(e,o)=>{const t=i._config.maxFileUploadSize,n=v().map(e,b).reduce(j,0);return!(t>0&&n>t)||(d({open:!0,key:"upload:"+o,message:r("explorer.UploadFailed",{folderName:null!==l&&void 0!==l?l:""}),description:r("data.explorer.FileUploadSizeLimit"),duration:3,toText:r("data.folders.OpenAFolder"),to:{search:new URLSearchParams({folder:o}).toString()}}),!1)},o[2]=i,o[3]=l,o[4]=r,o[5]=d,o[6]=g):g=o[6];const h=g;let x;o[7]!==i||o[8]!==l||o[9]!==s||o[10]!==h?(x=async(e,o,t)=>{if(!h(e,o))return;const n=[],r=v().map(e,(e=>(n.push(e),async l=>{const n=e.webkitRelativePath||e.name;try{const r=[t,n].filter(Boolean).join("/"),d=await i.vfolder.create_upload_session(r,e,o);return await new Promise(((o,t)=>{try{new y._O(e,{endpoint:d,uploadUrl:d,retryDelays:[0,3e3,5e3,1e4,2e4],chunkSize:U(e.size),storeFingerprintForResuming:!1,metadata:{filename:e.name,filetype:e.type},onProgress:(e,o)=>{var t;null===l||void 0===l||null===(t=l.onProgress)||void 0===t||t.call(l,e,o,n)},onSuccess:()=>{o({name:n,bytes:e.size})},onError:e=>{t(new Error(`Upload failed for ${n}`))}}).start()}catch(i){t(new Error(`Failed to initialize upload for ${n}`))}}))}catch(z){throw new Error(`Failed to prepare upload for ${n}`)}}))),d={vFolderId:o,vFolderName:null!==l&&void 0!==l?l:"",uploadFileInfo:v().zipWith(n,r,N)};s((e=>[...e,d]))},o[7]=i,o[8]=l,o[9]=s,o[10]=h,o[11]=x):x=o[11];const w=x;let z;return o[12]!==f||o[13]!==w||o[14]!==p?(z={uploadStatus:p,setUploadStatus:f,uploadFiles:w},o[12]=f,o[13]=w,o[14]=p,o[15]=z):z=o[15],z},U=e=>{const l=1048576;return e>=5120*l?200*l:e>=1024*l?100*l:e>=100*l?50*l:15*l};function b(e){return e.size}function j(e,l){return Math.max(e,l)}function N(e,l){return{file:e,startFunction:l}}}}]);
//# sourceMappingURL=818.8f7b0b82.chunk.js.map