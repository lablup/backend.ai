# Backend.AI AppProxy Worker Configuration (PROD Environment)
#
# This is a sample configuration file for the Backend.AI AppProxy Worker.
# All configuration options are documented with their descriptions,
# default values, and environment-specific examples.
#
# Generated using BackendAIConfigMeta annotations.


# Redis configuration for the proxy worker's internal operations including
# caching, pub/sub messaging for real-time updates, and session state
# management.
# Added in 25.9.0
[redis]
  # Address and port number of redis server.
  # Added in 25.13.0
  ## addr = { host = "redis-server", port = 6379 }
  # List of address/port pair of sentinel servers.
  # Added in 25.13.0
  ## sentinel = { host = "redis-sentinel:26379,redis-sentinel", port = 26380 }
  # Redis service name.
  # Added in 25.13.0
  ## service_name = "bai-service"
  # Redis password.
  # Added in 25.13.0
  ## password = "REDIS_PASSWORD"

  # Configuration for Redis helper library.
  # Added in 25.13.0
  [redis.redis_helper_config]
    # Timeout in seconds for Redis socket operations.
    # Added in 25.13.0
    socket_timeout = 10.0
    # Timeout in seconds for establishing Redis connections.
    # Added in 25.13.0
    socket_connect_timeout = 5.0
    # Time in seconds to wait between reconnection attempts.
    # Added in 25.13.0
    reconnect_poll_timeout = 1.0

# Core proxy worker settings including network binding, TLS, routing mode, and
# traffic filtering configuration.
# Added in 25.9.0
[proxy_worker]
  # The directory path where the proxy worker stores temporary UNIX domain
  # sockets for inter-process communication. These sockets handle internal
  # coordination between worker components. Ensure the directory exists and has
  # appropriate permissions.
  # Added in 25.9.0
  ipc_base_path = "/var/run/backend.ai/ipc"
  # The Python async event loop implementation to use. 'uvloop' provides better
  # performance and is recommended for all deployments. 'asyncio' is the
  # standard library fallback if uvloop is not available.
  # Added in 25.9.0
  event_loop = "asyncio"
  # The file path where the worker writes its process ID (PID). Used by process
  # managers (like systemd) to track and manage the service. Set to /dev/null to
  # disable PID file creation in development environments.
  # Added in 25.9.0
  pid_file = "/run/backend.ai/appproxy/worker.pid"
  # A unique identifier for this proxy worker instance. Used for logging,
  # monitoring, and distinguishing between multiple worker instances in a
  # cluster. Defaults to the hostname with 'i-' prefix.
  # Added in 25.9.0
  id = "i-worker-01"
  # The UNIX user ID (UID) that the worker process should run as. For security,
  # avoid running as root (UID 0) in production. The process will drop
  # privileges to this user after startup.
  # Added in 25.9.0
  user = 1000
  # The UNIX group ID (GID) that the worker process should run as. Should be set
  # to a group with appropriate permissions for accessing required files and
  # sockets.
  # Added in 25.9.0
  group = 1000
  # The network address and port where the worker's internal API server listens.
  # This API is used by the coordinator to manage the worker. Use '0.0.0.0' to
  # listen on all interfaces, or specify a specific IP for security.
  # Added in 25.9.0
  api_bind_addr = { host = "0.0.0.0", port = 10201 }
  # The external address that the coordinator should use to reach this worker's
  # API. Required when the worker is behind NAT or a load balancer where the
  # bind address differs from the externally accessible address.
  # Added in 25.9.0
  ## api_advertised_addr = { host = "worker.example.com", port = 10201 }
  # The HTTP(S) URL of the proxy coordinator's API endpoint. The worker connects
  # to this endpoint to register itself, receive proxy configuration updates,
  # and report status. Use https:// in production for secure communication.
  # Added in 25.9.0
  coordinator_endpoint = "https://coordinator:10200"
  # Whether to validate the coordinator's TLS/SSL certificate when connecting
  # via HTTPS. Set to false only in development with self-signed certificates.
  # Always enable in production to prevent man-in-the-middle attacks.
  # Added in 25.9.0
  verify_coordinator_ssl_certificate = true
  # A unique, human-readable identifier for this proxy worker's authority
  # domain. In high-availability setups with multiple workers behind a load
  # balancer, all workers serving the same endpoint must share the same
  # authority value.
  # Added in 25.9.0
  authority = "worker-1"
  # Enable the experimental Redis-based event dispatcher for real-time event
  # propagation from the coordinator. This feature is under development and may
  # have stability issues. Use with caution in production.
  # Added in 25.9.0
  use_experimental_redis_event_dispatcher = false
  # Enable HTTPS/TLS for the worker's API server and proxy connections. When
  # enabled, requires tls_cert and tls_privkey to be configured. Recommended for
  # production deployments to secure communication.
  # Added in 25.9.0
  tls_listen = true
  # The file path to the TLS/SSL certificate in PEM format. Required when
  # tls_listen is enabled. The certificate should be issued for the domain/IP
  # used to access the worker. For production, use certificates from a trusted
  # CA.
  # Added in 25.9.0
  ## tls_cert = "/etc/backend.ai/tls/cert.pem"
  # The file path to the TLS/SSL private key in PEM format. Required when
  # tls_listen is enabled. This file must be kept secure with restricted
  # permissions (e.g., 0600). Never commit this file to version control.
  # Added in 25.9.0
  ## tls_privkey = "/path/to/file"
  # Set to true when the worker is behind a TLS-terminating load balancer or
  # reverse proxy (e.g., nginx, HAProxy). This tells the worker to advertise
  # HTTPS URLs even though it receives unencrypted traffic from the proxy.
  # Added in 25.9.0
  tls_advertised = true
  # The port number for the aiomonitor terminal UI debugging server. Allows
  # real-time inspection of asyncio tasks and event loop status via a terminal
  # interface. Useful for debugging async issues. Firewall this port in
  # production.
  # Added in 25.9.0
  aiomonitor_termui_port = 48600
  # The port number for the aiomonitor web-based debugging interface. Provides a
  # browser-accessible dashboard for monitoring asyncio tasks and event loop
  # metrics. Ensure this port is firewalled in production environments.
  # Added in 25.9.0
  aiomonitor_webui_port = 49600
  # The interval in seconds between heartbeat messages sent to the coordinator.
  # The coordinator uses these heartbeats to detect worker failures. Must be
  # shorter than the coordinator's worker_heartbeat_timeout setting.
  # Added in 25.9.0
  heartbeat_period = 10.0
  # The routing mode for this proxy worker. 'wildcard' uses subdomain-based
  # routing, 'port' uses port-based routing, 'traefik' delegates routing to
  # Traefik. Choose based on your network infrastructure and DNS capabilities.
  # Added in 25.9.0
  frontend_mode = "wildcard"
  # The protocol to use for proxied connections. 'http' for HTTP/1.1 traffic,
  # 'h2' for HTTP/2 traffic (requires http2 config), 'tcp' for raw TCP proxying.
  # 'grpc' is not directly supported; use 'h2' instead for gRPC traffic.
  # Added in 25.9.0
  protocol = "http"
  # The types of traffic this worker accepts. Use 'interactive' for user-facing
  # applications (Jupyter, VSCode, etc.) and 'inference' for model serving
  # endpoints. Separate workers for each traffic type enables specialized
  # scaling.
  # Added in 25.9.0
  accepted_traffics = "interactive,inference"
  # When enabled, this worker only proxies applications that match the defined
  # app_filters. When disabled (default), the worker accepts all traffic
  # matching accepted_traffics. Use with app_filters to create dedicated workers
  # for specific applications.
  # Added in 25.9.0
  filtered_apps_only = false
  # CIDR notation specifying which IP addresses can access the /metrics HTTP
  # endpoint. This endpoint exposes Prometheus-compatible metrics for
  # monitoring. Restrict access to your monitoring infrastructure network in
  # production to prevent information disclosure.
  # Added in 25.9.0
  metric_access_allowed_hosts = "10.0.0.0/8"
  # The interval in seconds between collecting metrics from inference model
  # endpoints. Metrics include request counts, latencies, and throughput. Lower
  # values provide more granular data but increase overhead on model services.
  # Added in 25.9.0
  inference_metric_collection_interval = 5.0
  # The interval in seconds for cleaning up idle HTTP client sessions. The
  # worker maintains a pool of aiohttp.ClientSession instances for backend
  # connections. Periodic cleanup prevents resource leaks from accumulated idle
  # connections.
  # Added in 25.9.0
  client_pool_cleanup_interval = 60.0
  # The address this worker announces to the service discovery system. Other
  # components use this address to locate and connect to the worker. If not set,
  # defaults to api_bind_addr. Required when behind NAT or containers.
  # Added in 25.9.0
  ## announce_addr = { host = "worker.example.com", port = 10201 }

  # Configuration for wildcard domain routing. Required when frontend_mode is
  # 'wildcard'. Defines the bind address, base domain, and port settings for
  # subdomain-based routing.
  # Added in 25.9.0
  [proxy_worker.wildcard_domain]
    # The network address and port where the wildcard domain proxy server
    # listens. This enables subdomain-based routing where each session gets a
    # unique subdomain (e.g., session-abc.proxy.example.com).
    # Added in 25.9.0
    bind_addr = { host = "0.0.0.0", port = 10205 }
    # The base wildcard domain suffix for routing. Must start with a dot. The
    # proxy creates subdomains under this domain for each proxied application
    # (e.g., '.proxy.backend.ai' enables 'app123.proxy.backend.ai').
    # Added in 25.9.0
    domain = ".example.proxy.backend.ai"
    # The externally accessible port number when the worker is behind NAT or a
    # load balancer. Required when the external port differs from the bind_addr
    # port. Leave empty if the worker is directly accessible.
    # Added in 25.9.0
    ## advertised_port = 10205

  # Configuration for port-based routing. Required when frontend_mode is 'port'.
  # Defines the host, port ranges, and advertised addresses for port-based
  # routing.
  # Added in 25.9.0
  [proxy_worker.port_proxy]
    # The host address for the port-based proxy to listen on. Use '0.0.0.0' to
    # listen on all network interfaces, or specify a specific IP to restrict
    # access. Port-based proxying assigns each session a unique port number.
    # Added in 25.9.0
    bind_host = "0.0.0.0"
    # The externally accessible hostname for the port proxy when behind NAT or
    # load balancer. Clients use this hostname to connect to proxied
    # applications. Leave empty if the worker is directly accessible at
    # bind_host.
    # Added in 25.9.0
    ## advertised_host = "worker.example.com"
    # The range of ports (min, max) that can be allocated for proxied
    # applications. Each proxied session gets a unique port from this range.
    # Ensure the range is large enough for your expected concurrent sessions and
    # firewall rules allow access.
    # Added in 25.9.0
    bind_port_range = "10205,10300"
    # The externally accessible port range when the worker is behind NAT or port
    # mapping. Required when external ports differ from bind_port_range. Must be
    # the same size as bind_port_range for correct port mapping.
    # Added in 25.9.0
    ## advertised_port_range = "10205,10300"

  # Configuration for Traefik-delegated routing. Required when frontend_mode is
  # 'traefik'. The worker configures Traefik dynamically instead of handling
  # routing directly.
  # Added in 25.9.0
  [proxy_worker.traefik]
    # The port number where Traefik's API/dashboard is accessible. The proxy
    # worker uses this port to communicate with Traefik for dynamic
    # configuration. Ensure this matches your Traefik's api entrypoint
    # configuration.
    # Added in 25.9.0
    api_port = 8080
    # The routing mode for Traefik-based proxying. 'wildcard' uses subdomain-
    # based routing (e.g., app123.proxy.example.com), 'port' uses port-based
    # routing (e.g., proxy.example.com:12345). Choose based on your network and
    # DNS setup.
    # Added in 25.9.0
    frontend_mode = "wildcard"
    # The directory where the worker stores timestamp files tracking last
    # activity for each proxied application. Used to determine when circuits can
    # be garbage collected. Ensure the worker process has write permissions to
    # this directory.
    # Added in 25.9.0
    last_used_time_marker_directory = "/var/lib/backend.ai/appproxy/worker"

    # Configuration for Traefik wildcard domain routing. Required when
    # frontend_mode is 'wildcard'. Defines the base domain and TLS settings for
    # subdomain-based application routing.
    # Added in 25.9.0
    [proxy_worker.traefik.wildcard_domain]
      # The base wildcard domain for Traefik-based subdomain routing. Must start
      # with a dot. Traefik creates dynamic subdomains under this domain for
      # each proxied application (e.g., '.proxy.backend.ai' enables
      # 'app123.proxy.backend.ai').
      # Added in 25.9.0
      domain = ".example.proxy.backend.ai"
      # The port number that clients use to access Traefik wildcard domains.
      # Typically 443 for HTTPS or 80 for HTTP. This should match the port where
      # Traefik is configured to receive wildcard domain traffic.
      # Added in 25.9.0
      advertised_port = 443
      # Set to true if Traefik provides TLS termination for wildcard domain
      # traffic. When enabled, the proxy worker advertises HTTPS URLs to
      # clients. Requires proper TLS certificate configuration in Traefik.
      # Added in 25.9.0
      tls_advertised = true

    # Configuration for Traefik port-based routing. Required when frontend_mode
    # is 'port'. Defines the port range and hostname for port-based application
    # routing.
    # Added in 25.9.0
    [proxy_worker.traefik.port_proxy]
      # The hostname that clients should use to connect to Traefik-proxied
      # applications. This should be the externally accessible hostname where
      # Traefik routes traffic. Used when Traefik handles port-based routing for
      # the proxy worker.
      # Added in 25.9.0
      advertised_host = "worker.example.com"
      # The range of ports (min, max) that Traefik can use for port-based
      # application proxying. Traefik allocates ports from this range for each
      # proxied application. Configure corresponding Traefik entrypoints for
      # each port in this range.
      # Added in 25.9.0
      port_range = "10205,10300"

  # Configuration for HTTP/2 protocol support using nghttpx. Required when
  # protocol is 'h2'. Defines the nghttpx binary path and API port pool for
  # HTTP/2 proxying.
  # Added in 25.9.0
  [proxy_worker.http2]
    # The absolute filesystem path to the nghttpx binary. nghttpx is used for
    # HTTP/2 proxy support in Backend.AI. Ensure the binary is installed and
    # executable. Install via package manager or build from nghttp2 source.
    # Added in 25.9.0
    nghttpx_path = "/usr/local/bin/nghttpx"
    # The port range (min, max) for nghttpx internal API communication. These
    # ports are used for the worker to communicate with nghttpx instances.
    # Should not overlap with other service ports on the same host.
    # Added in 25.9.0
    api_port_pool = "50000,60000"

  # Filter rules to route specific applications to this worker. Each filter
  # matches applications by key-value pairs. Useful for routing specific
  # sessions or users to dedicated workers for isolation or performance.
  # Added in 25.9.0
  [proxy_worker.app_filters]

# Performance profiling configuration for debugging and optimization. Includes
# settings for cProfile and Pyroscope continuous profiling.
# Added in 25.9.0
[profiling]
  # Starts a memray live server.
  # Added in 25.13.0
  enable_memray = false
  # Path to store memray allocation captures.
  # Added in 25.13.0
  memray_output_destination = "/var/log/backend.ai/memray/proxy-worker.bin"
  # Allows sending pyroscope telemetry to pyroscope server.
  # Added in 25.13.0
  enable_pyroscope = false

  # Pyroscope configuration.
  # Added in 25.13.0
  [profiling.pyroscope_config]
    # Pyroscope application name.
    # Added in 25.13.0
    ## application_name = "proxy-worker-prod"
    # Pyroscope server endpoint.
    # Added in 25.13.0
    server_address = "http://pyroscope:4040"
    # Pyroscope sample rate.
    # Added in 25.13.0
    sample_rate = 100
    # Detect subprocesses started by the main process.
    # Added in 25.13.0
    detect_subprocesses = true
    # Report cpu time only.
    # Added in 25.13.0
    oncpu = true
    # Only include traces for threads that are holding on to the Global
    # Interpreter Lock.
    # Added in 25.13.0
    gil_only = true
    # Enable logging facility.
    # Added in 25.13.0
    enable_logging = false

    # Pyroscope tags.
    # Added in 25.13.0
    [profiling.pyroscope_config.tags]

# Secret keys and tokens used for authenticating requests between the worker and
# coordinator. Must match the secrets configured in the coordinator.
# Added in 25.9.0
[secrets]
  # String used for creating JWT signature. Must be identical across every nodes
  # across single AppProxy cluster.
  # Added in 25.13.0
  jwt_secret = "JWT_SECRET"
  # API token used for validating requests from AppProxy worker and Backend.AI
  # manager.
  # Added in 25.13.0
  api_secret = "API_SECRET"

# Configuration for permit hash validation, which verifies the authenticity of
# proxy configuration requests from the coordinator.
# Added in 25.9.0
[permit_hash]
  # Secret string used for creating permit hash.
  # Added in 25.13.0
  secret = "PERMIT_HASH_SECRET"
  # Hash digest method to use.
  # Added in 25.13.0
  digest_mod = "SHA256"

# Logging configuration including log levels, output formats, and destinations.
# Supports console, file, and external log aggregation systems.
# Added in 25.9.0
[logging]
  # The version used by logging.dictConfig().
  # Added in 24.09.0
  version = 1
  # The main log level to filter messages from all loggers.
  # Added in 24.09.0
  level = "INFO"
  # Disable the existing loggers when applying the config.
  # Added in 24.09.0
  disable-existing-loggers = false
  # The mapping of log handler configurations.
  # Added in 24.09.0
  handlers = {}
  # The mapping of per-namespace logger configurations.
  # Added in 24.09.0
  loggers = {}
  # The list of log drivers to activate.
  # Added in 24.09.0
  drivers = ["console", "file"]
  # Override default log level for specific scope of package.
  # Added in 24.09.0
  pkg-ns = "{ \"\" = \"WARNING\", \"ai.backend\" = \"INFO\" }"

  # Console logging driver configuration.
  # Added in 24.09.0
  [logging.console]
    # Opt to print colorized log.
    # Added in 24.09.0
    ## colored = true
    # Determine verbosity of log.
    # Added in 24.09.0
    format = "verbose"

  # File logging driver configuration.
  # Added in 24.09.0
  [logging.file]
    # Path to store log.
    # Added in 24.09.0
    path = "/var/log/backend.ai"
    # Log file name.
    # Added in 24.09.0
    filename = "manager.log"
    # Number of outdated log files to retain.
    # Added in 24.09.0
    backup-count = 10
    # Maximum size for a single log file.
    # Added in 24.09.0
    rotation-size = "100MB"
    # Determine verbosity of log.
    # Added in 24.09.0
    format = "verbose"

  # Logstash logging driver configuration.
  # Added in 24.09.0
  [logging.logstash]
    # Protocol to communicate with logstash server.
    # Added in 24.09.0
    protocol = "tcp"
    # Use TLS to communicate with logstash server.
    # Added in 24.09.0
    ssl-enabled = true
    # Verify validity of TLS certificate when communicating with logstash.
    # Added in 24.09.0
    ssl-verify = true

    # Connection information of logstash node.
    # Added in 24.09.0
    [logging.logstash.endpoint]

  # Graylog logging driver configuration.
  # Added in 24.09.0
  [logging.graylog]
    # Graylog hostname.
    # Added in 24.09.0
    host = "graylog-server"
    # Graylog server port number.
    # Added in 24.09.0
    port = 12201
    # Log level.
    # Added in 24.09.0
    level = "INFO"
    # The custom source identifier. If not specified, fqdn will be used instead.
    # Added in 24.09.0
    ## localname = "prod-manager-01"
    # The fully qualified domain name of the source.
    # Added in 24.09.0
    ## fqdn = "manager.backend.ai"
    # Verify validity of TLS certificate when communicating with Graylog.
    # Added in 24.09.0
    ssl-verify = true
    # Path to Root CA certificate file.
    # Added in 24.09.0
    ## ca-certs = "/etc/ssl/ca.pem"
    # Path to TLS private key file.
    # Added in 24.09.0
    ## keyfile = "/etc/backend.ai/graylog/privkey.pem"
    # Path to TLS certificate file.
    # Added in 24.09.0
    ## certfile = "/etc/backend.ai/graylog/cert.pem"

# Debug mode settings for development and troubleshooting. Enables verbose
# logging and additional diagnostic features when enabled.
# Added in 25.9.0
[debug]
  # Enable debug mode.
  # Added in 25.13.0
  enabled = false
  # Enable asyncio debug mode.
  # Added in 25.13.0
  asyncio = false
  # Enable enhanced aiomonitor task info.
  # Added in 25.13.0
  enhanced_aiomonitor_task_info = false
  # Enable event logging.
  # Added in 25.13.0
  log_events = false
  # Enable statistics logging.
  # Added in 25.13.0
  log_stats = false

# OpenTelemetry configuration for distributed tracing and observability. Exports
# trace data to OTLP-compatible backends (Jaeger, Zipkin, etc.) for visualizing
# request flows through the proxy worker.
# Added in 25.9.0
[otel]
  # Whether to enable OpenTelemetry for tracing or logging. When enabled, traces
  # or logs will be collected and sent to the configured OTLP endpoint.
  # Added in 25.7.0
  enabled = true
  # Log level for OpenTelemetry. Controls the verbosity of logs generated by
  # OpenTelemetry. Common levels include 'DEBUG', 'INFO', 'WARN', 'ERROR'.
  # Added in 25.7.0
  log-level = "INFO"
  # OTLP endpoint for sending traces. Should include the host and port of the
  # OTLP receiver.
  # Added in 25.7.0
  endpoint = "http://otel-collector:4317"

# Service discovery configuration for locating the coordinator and other
# Backend.AI components. Supports Redis-based or etcd-based service registration
# and discovery.
# Added in 25.9.0
[service_discovery]
  # Type of service discovery to use. Supported types are 'etcd' and 'redis'.
  # Added in 25.9.0
  type = "redis"

# etcd connection configuration for distributed coordination. Used for service
# discovery (if etcd-based) and shared configuration management.
# Added in 25.9.0
[etcd]
  # Namespace prefix for etcd keys used by Backend.AI. Allows multiple
  # Backend.AI clusters to share the same etcd cluster. All Backend.AI related
  # keys will be stored under this namespace.
  # Added in 22.03.0
  namespace = "backend"
  # Network address of the etcd server. Default is the standard etcd port on
  # localhost. In production, should point to one or more etcd instance
  # endpoint(s).
  # Added in 22.03.0
  addr = { host = "etcd-cluster", port = 2379 }
  # Username for authenticating with etcd. Optional if etcd doesn't require
  # authentication. Should be set along with password for secure deployments.
  # Added in 22.03.0
  ## user = "backend"
  # Password for authenticating with etcd. Should be kept secret in production
  # environments. Set together with the user field for authentication.
  # Added in 22.03.0
  ## password = "ETCD_PASSWORD"

# Pyroscope continuous profiling configuration for production performance
# analysis. Sends CPU and memory profiling data to a Pyroscope server for flame
# graph visualization.
# Added in 25.9.0
[pyroscope]
  # Whether to enable Pyroscope profiling. When enabled, performance profiling
  # data will be sent to a Pyroscope server. Useful for debugging performance
  # issues, but adds some overhead.
  # Added in 24.12.1
  enabled = true
  # Application name to use in Pyroscope. This name will identify this component
  # instance in Pyroscope UI. Required if Pyroscope is enabled.
  # Added in 24.12.1
  ## app-name = "backendai-manager-prod"
  # Address of the Pyroscope server. Must include the protocol (http or https)
  # and port if non-standard. Required if Pyroscope is enabled.
  # Added in 24.12.1
  ## server-addr = "http://pyroscope:4040"
  # Sampling rate for Pyroscope profiling. Higher values collect more data but
  # increase overhead. Balance based on your performance monitoring needs.
  # Added in 24.12.1
  ## sample-rate = 100
