# Backend.AI Storage Proxy Configuration Sample
#
# This is a sample configuration file for the Backend.AI Storage Proxy.
# All configuration options are documented with their descriptions,
# default values, and examples.
#
# Generated automatically from the StorageProxyUnifiedConfig schema.

# Core storage-proxy service configuration.
# Controls how the storage-proxy operates and communicates.
[storage-proxy]
  # Base directory path for inter-process communication files.
  # Used for Unix domain sockets and other IPC mechanisms.
  ipc-base-path = "/tmp/backend.ai/ipc"
  # Unique identifier for this storage-proxy node.
  # Used for service discovery and coordination.
  node-id = "storage-proxy-1"
  # Number of worker processes to spawn.
  # Defaults to the number of CPU cores available.
  num-proc = 12
  # Path to the file where the process ID will be written.
  # Set to /dev/null to disable this feature.
  pid-file = "/dev/null"
  # Event loop implementation to use.
  # 'asyncio' is the standard library implementation.
  # 'uvloop' is a faster alternative but may have compatibility issues.
  event-loop = "asyncio"
  # Maximum number of entries to scan in directory operations.
  # Prevents excessive memory usage when scanning large directories.
  scandir-limit = 1000
  # Maximum size allowed for file uploads.
  # Prevents storage exhaustion from large uploads.
  max-upload-size = "100g"
  # Secret key for generating JWT tokens.
  # Used for authenticating client requests.
  secret = "jwt-secret-key"
  # Session expiration time.
  # Controls how long JWT tokens remain valid.
  session-expire = "1h"
  # User ID to run the storage-proxy process as.
  # Defaults to the UID of the current file's owner.
  ## user = "501"
  # Group ID to run the storage-proxy process as.
  # Defaults to the GID of the current file's owner.
  ## group = "20"
  # Port for the aiomonitor terminal UI.
  # Allows connecting to a debugging console.
  aiomonitor-termui-port = 38300
  # Port for the aiomonitor web UI.
  # Provides a web-based monitoring interface.
  aiomonitor-webui-port = 39300
  # Path prefix for watcher input sockets.
  # Used for communication with watcher processes.
  ## watcher-insock-path-prefix = "/tmp/backend.ai/watcher"
  # Path prefix for watcher output sockets.
  # Used for communication with watcher processes.
  ## watcher-outsock-path-prefix = "/tmp/backend.ai/watcher"
  # Whether to use watcher processes.
  # Enables additional monitoring capabilities.
  use-watcher = false
  # Whether to use experimental Redis-based event dispatcher.
  # May provide better performance for event handling.
  use-experimental-redis-event-dispatcher = false
  # Whether to allow automatic creation of quota scopes.
  # If true, quota scopes will be created when creating VFolders in non-existent
  # quota scopes.
  # If false, VFolder creation will fail if the quota scope does not exist.
  allow-auto-quota-scope-creation = true

# Pyroscope profiling configuration.
# Controls integration with the Pyroscope performance profiling tool.
[pyroscope]
  # Whether to enable Pyroscope profiling.
  # When enabled, performance profiling data will be sent to a Pyroscope server.
  # Useful for debugging performance issues, but adds some overhead.
  enabled = false
  # Application name to use in Pyroscope.
  # This name will identify this storage-proxy instance in Pyroscope UI.
  # Required if Pyroscope is enabled.
  ## app-name = "backendai-storage-proxy"
  # Address of the Pyroscope server.
  # Must include the protocol (http or https) and port if non-standard.
  # Required if Pyroscope is enabled.
  ## server-addr = "http://localhost:4040"
  # Sampling rate for Pyroscope profiling.
  # Higher values collect more data but increase overhead.
  # Balance based on your performance monitoring needs.
  ## sample-rate = 10

# Logging system configuration.
# Controls how logs are formatted, filtered, and stored.
[logging]
  # The version used by logging.dictConfig().
  version = 1
  # The main log level to filter messages from all loggers.
  level = "INFO"
  # Disable the existing loggers when applying the config.
  disable-existing-loggers = false
  # The list of log drivers to activate.
  drivers = [ "console",]

  # The mapping of log handler configurations.
  [logging.handlers]

  # The mapping of per-namespace logger configurations.
  [logging.loggers]

  [logging.console]
    # Opt to print colorized log.
    ## colored = true
    # Determine verbosity of log.
    format = "verbose"

  [logging.file]
    # Path to store log.
    path = "/var/log/backend.ai"
    # Log file name.
    filename = "wsproxy.log"
    # Number of outdated log files to retain.
    backup-count = 5
    # Maximum size for a single log file.
    ## rotation-size = "..."  # |     # min=0
    # Determine verbosity of log.
    format = "verbose"

  [logging.logstash]
    # Connection information of logstash node.
    endpoint = { host = "127.0.0.1", port = 8001 }
    # Protocol to communicate with logstash server.
    protocol = "tcp"
    # Use TLS to communicate with logstash server.
    ssl-enabled = true
    # Verify validity of TLS certificate when communicating with logstash.
    ssl-verify = true

  [logging.graylog]
    # Graylog hostname.
    host = "127.0.0.1"
    # Graylog server port number.
    port = 8000
    # Log level.
    level = "INFO"
    # The custom source identifier. If not specified, fqdn will be used instead.
    ## localname = "..."
    # The fuly qualified domain name of the source.
    ## fqdn = "..."
    # Verify validity of TLS certificate when communicating with logstash.
    ssl-verify = true
    # Path to Root CA certificate file.
    ## ca-certs = "/etc/ssl/ca.pem"
    # Path to TLS private key file.
    ## keyfile = "/etc/backend.ai/graylog/privkey.pem"
    # Path to TLS certificate file.
    ## certfile = "/etc/backend.ai/graylog/cert.pem"

  # Override default log level for specific scope of package
  [logging.pkg_ns]

# API configuration for client and manager interfaces.
# Controls how the storage-proxy serves requests.
[api]
  # Configuration for the client-facing API.
  # Handles file operations requested by users.
  [api.client]
    # Network address and port where the client API service will listen.
    # This is the address accessible by clients for file operations.
    service-addr = { host = "127.0.0.1", port = 6021 }
    # Whether to enable SSL/TLS for client API connections.
    # Required for secure communication with clients.
    ssl-enabled = true
    # Path to the SSL certificate file for client API.
    # Required if ssl_enabled is True.
    ## ssl-cert = "/etc/ssl/certs/storage-proxy.crt"
    # Path to the SSL private key file for client API.
    # Required if ssl_enabled is True.
    ## ssl-privkey = "/etc/ssl/private/storage-proxy.key"

  # Configuration for the manager-facing API.
  # Handles control operations from manager services.
  [api.manager]
    # Network address and port where the manager API service will listen.
    # This is the address accessible by managers for control operations.
    service-addr = { host = "127.0.0.1", port = 6022 }
    # Address and port to announce to managers for service discovery.
    # Should be accessible by other manager components.
    announce-addr = { host = "127.0.0.1", port = 6022 }
    # Address and port to announce for internal manager API requests.
    # Used for service discovery within container environments.
    announce-internal-addr = { host = "host.docker.internal", port = 6023 }
    # Internal address where manager API listens for internal requests.
    # Used for internal communication between services.
    internal-addr = { host = "127.0.0.1", port = 16023 }
    # Whether to enable SSL/TLS for manager API connections.
    # Required for secure communication with managers.
    ssl-enabled = true
    # Path to the SSL certificate file for manager API.
    # Required if ssl_enabled is True.
    ## ssl-cert = "/etc/ssl/certs/storage-proxy.crt"
    # Path to the SSL private key file for manager API.
    # Required if ssl_enabled is True.
    ## ssl-privkey = "/etc/ssl/private/storage-proxy.key"
    # Secret key for authenticating managers with the storage-proxy.
    # Must be shared between manager and storage-proxy instances.
    secret = "manager-secret-key"

# Volume configuration.
# Defines available storage backends and their settings.
[volume]

# Debugging options configuration.
# Controls various debugging features and tools.
[debug]
  # Master switch for debug mode.
  # When enabled, activates various debugging features.
  # Should be disabled in production for security and performance.
  enabled = false
  # Whether to enable asyncio debug mode.
  # Helps detect problems like coroutines never awaited.
  # Adds significant overhead, use only during development.
  asyncio = false
  # Enable enhanced task information in aiomonitor.
  # Provides more detailed information about running asyncio tasks.
  enhanced-aiomonitor-task-info = false
  # Whether to log all internal events.
  # Very verbose, but useful for debugging event-related issues.
  log-events = false

# Service discovery configuration.
# Controls how services are discovered and connected.
[service-discovery]
  # Type of service discovery to use.
  type = "redis"

# OpenTelemetry configuration.
# Controls how tracing and logging are handled.
[otel]
  # Whether to enable OpenTelemetry for tracing or logging.
  # When enabled, traces or logs will be collected and sent to the configured OTLP
  # endpoint.
  enabled = false
  # Log level for OpenTelemetry.
  # Controls the verbosity of logs generated by OpenTelemetry.
  log-level = "INFO"
  # OTLP endpoint for sending traces.
  # Should include the protocol, host and port of the OTLP receiver.
  endpoint = "http://127.0.0.1:4317"

# Etcd configuration settings.
# Used for distributed coordination.
[etcd]
  # Namespace prefix for etcd keys used by Backend.AI.
  # Allows multiple Backend.AI clusters to share the same etcd cluster.
  # All Backend.AI related keys will be stored under this namespace.
  namespace = "ETCD_NAMESPACE"
  # Network address of the etcd server.
  # Default is the standard etcd port on localhost.
  # In production, should point to one or more etcd instance endpoint(s).
  ## addr = { host = "127.0.0.1", port = 2379 }  # | [ { host = "127.0.0.1", port = 2379 } ]
  # Username for authenticating with etcd.
  # Optional if etcd doesn't require authentication.
  # Should be set along with password for secure deployments.
  ## user = "backend"
  # Password for authenticating with etcd.
  # Optional if etcd doesn't require authentication.
  # Can be a direct password or environment variable reference.
  ## password = "develove"

# Dictionary of artifact storage configurations keyed by name.
# Each configuration defines how to connect to and use an artifact storage
# service.
[artifact-storages]

# Dictionary of artifact registry configurations keyed by name.
# Each configuration defines how to connect to and use an artifact registry
# service.
[artifact-registries]

# Reservoir client configuration.
# Controls timeout settings for HTTP client connections to reservoir registries.
[reservoir-client]
  # Total timeout for the entire request (in seconds).
  # None means no timeout.
  ## timeout-total = 300.0
  # Timeout for acquiring a connection from the pool (in seconds).
  # None means no timeout.
  ## timeout-connect = 60.0
  # Timeout for connecting to a peer for a new connection (in seconds).
  # None means no timeout.
  ## timeout-sock-connect = 30.0
  # Timeout for reading a portion of data from a peer (in seconds).
  # None means no timeout.
  ## timeout-sock-read = 300.0

# Deprecated, use `artifact_storages` instead.
#
# List of object storage configurations.
# Each configuration defines how to connect to and use an object storage
# service.
[[storages]]
# Add multiple [[storages]] sections as needed
  # Endpoint URL for the object storage service.
  # Should include the protocol (http or https) and port if non-standard.
  endpoint = "http://localhost:9000"
  # Access key for authenticating with the object storage service.
  # Required for services that use access keys for authentication.
  access-key = "my-access-key"
  # Secret key for authenticating with the object storage service.
  # Required for services that use secret keys for authentication.
  secret-key = "my-secret-key"
  # List of bucket names managed by this storage configuration.
  buckets = "my-bucket"
  # Region where the object storage service is located.
  # Required for services that require region specification.
  region = "us-west-1"
  # Chunk size (in bytes) for uploading files to the object storage.
  # Should be greater than or equal to 5 MiB due to S3 requirements.
  upload-chunk-size = 5242880
  # Chunk size (in bytes) for downloading files from the object storage.
  download-chunk-size = 8192
  # Chunk size (in bytes) for downloading files from the remote reservoir storage.
  reservoir-download-chunk-size = 8192
  # Name of the object storage configuration.
  # Used to identify this storage in the system.
  name = "s3-storage"

  # Configuration for presigned upload URLs.
  # Controls parameters like expiration time and size limits.
  [storages.presigned-upload]
    # Minimum file size for multipart uploads.
    # If None, no minimum size limit is enforced.
    ## min-size = 5242880
    # Maximum file size for uploads.
    # If None, no maximum size limit is enforced.
    ## max-size = 5368709120
    # Expiration time (in seconds) for presigned URLs.
    expiration = 300

  # Configuration for presigned download URLs.
  # Controls parameters like expiration time.
  [storages.presigned-download]
    # Expiration time (in seconds) for presigned URLs.
    expiration = 300

# Deprecated, use `artifact_registries` instead.
#
# List of artifact registry configurations.
# Each configuration defines how to connect to and use an artifact registry
# service.
[[registries]]
# Add multiple [[registries]] sections as needed
  # Name of the artifact registry configuration.
  # Used to identify this registry in the system.
  name = "huggingface"
  # Configuration for the artifact registry.
  config = "..."
