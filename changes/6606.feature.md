Improve bgtask infrastructure with repository pattern and type adapters