Enhance Scheduler allocation logic and add comprehensive tests