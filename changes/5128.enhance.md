Separate repository layer from agent service