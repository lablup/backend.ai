Document the internal logic of affinity-aware device allocation and improve error messages
